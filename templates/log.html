<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ø³Ø¬Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</title>
    <!-- Ø±Ø§Ø¨Ø· Ù„Ù…Ù„Ù CSS Ø®Ø§Ø±Ø¬ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"> -->
     <style>
        /* --- Ø£Ù†Ù…Ø§Ø· Ù…Ø´Ø§Ø¨Ù‡Ø© Ù„Ù€ index.html --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction: rtl; background-color: #f0f2f5; color: #333; padding: 20px; margin: 0; }
        h1, h2 { text-align: center; color: #2c3e50; }
        .main-table { width: 100%; margin: 20px auto; background-color: #fff; border-collapse: collapse; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden; }
        .main-table th, .main-table td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #eee; }
        .main-table tr:last-child td { border-bottom: none; }
        .main-table th { background-color: #3498db; color: white; font-weight: 600; position: sticky; top: 0; z-index: 1; } /* Ø¬Ø¹Ù„ Ø§Ù„Ø±Ø£Ø³ Ø«Ø§Ø¨ØªÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        td.username { font-weight: bold; color: #2980b9; }
        td.message { white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; text-align: right; padding-right: 15px; padding-left: 15px; }
        .timestamp { color: #7f8c8d; font-size: 0.85em; white-space: nowrap; }
        .bot-message td { background-color: #f8f9f9; color: #c0392b; font-style: italic; }

         /* --- Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ --- */
         body.dark-mode { background-color: #1e272e; color: #ecf0f1; }
         body.dark-mode h1, body.dark-mode h2 { color: #ecf0f1; }
         body.dark-mode .main-table { background-color: #2c3e50; color: #ecf0f1; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
         body.dark-mode .main-table th { background-color: #34495e !important; color: #ecf0f1; }
         body.dark-mode .main-table td { border-bottom-color: #34495e; }
         body.dark-mode tr:last-child td { border-bottom: none; }
         body.dark-mode a { color: #5dade2; } /* Ù„ÙˆÙ† Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
         body.dark-mode a:hover { color: #85c1e9; }
         body.dark-mode .timestamp { color: #95a5a6; }
         body.dark-mode .bot-message td { background-color: #34495e; color: #e74c3c; }

         /* --- Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© --- */
         .back-button { display: inline-block; margin: 20px 10px 0 0; padding: 10px 25px; background-color: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; text-decoration: none; text-align: center; }
         .back-button:hover { background-color: #7f8c8d; color: white;}
         body.dark-mode .back-button { background-color: #7f8c8d; }
         body.dark-mode .back-button:hover { background-color: #95a5a6; color: white;}

         /* --- ÙÙ„Ø§ØªØ± Ø§Ù„Ø³Ø¬Ù„ --- */
         .log-filters { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; padding: 10px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
         .log-filters input { padding: 8px 12px; border-radius: 5px; font-size: 1em; border: 1px solid #ccc; min-width: 150px; }
         body.dark-mode .log-filters { background-color: #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
         body.dark-mode .log-filters input { background-color: #34495e; color: #ecf0f1; border-color: #4a6378; }
         body.dark-mode .log-filters input::placeholder { color: #bdc3c7; }

         /* --- Ø²Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„ --- */
         .export-log-button { padding: 10px 20px; background-color: #16a085; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; }
         .export-log-button:hover { background-color: #117a65; }
         body.dark-mode .export-log-button { background-color: #1abc9c; }
         body.dark-mode .export-log-button:hover { background-color: #16a085; }

         /* --- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ --- */
         #loadingIndicator { text-align: center; padding: 10px; color: #888; font-style: italic; display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ */ }
         body.dark-mode #loadingIndicator { color: #aaa; }

         /* --- Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† --- */
         .title-bar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; padding-bottom: 15px; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
         .title-bar h1 { margin: 0; flex-grow: 1; text-align: right; } /* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙŠØ£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© */
         .title-bar .button-group { display: flex; gap: 10px; } /* Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
          body.dark-mode .title-bar { border-bottom-color: #34495e; }

    </style>
    <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© Excel Ù„Ù„ØªØµØ¯ÙŠØ± -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body> <!-- Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙ„Ø§Ø³ Ù‡Ù†Ø§ØŒ Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© JS -->
    <div class="title-bar">
         <div class="button-group">
             <a href="/" class="back-button">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©</a>
             <button onclick="exportLogToExcel()" class="export-log-button">ğŸ“ ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„</button>
         </div>
         <h1 style="margin-bottom: 10px;">Ø³Ø¬Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h1>
         <div style="min-width: 150px; text-align: left;"> <!-- Ù…Ø³Ø§Ø­Ø© ÙØ§Ø±ØºØ© Ù„Ù„Ù…ÙˆØ§Ø²Ù†Ø© Ø£Ùˆ ÙˆØ¶Ø¹ Ø¹Ù†Ø§ØµØ± Ø£Ø®Ø±Ù‰ -->
              <span id="messageCountLog" style="font-weight: bold; color: #555;">(ØªØ­Ù…ÙŠÙ„...)</span>
         </div>
    </div>

     <div class="log-filters">
        <input type="text" id="logUserSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..." aria-label="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"/>
        <input type="time" id="logFromTime" aria-label="Ù…Ù† ÙˆÙ‚Øª"/>
        <input type="time" id="logToTime" aria-label="Ø¥Ù„Ù‰ ÙˆÙ‚Øª"/>
      </div>

    <table class="main-table" id="messagesTableLog">
        <thead>
            <tr>
                <th>ÙˆÙ‚Øª Ø§Ù„Ù†Ø¸Ø§Ù…</th>
                <th>ÙˆÙ‚Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                <th>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>
            </tr>
        </thead>
        <tbody id="messages_table_log">
             <tr><td colspan="4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©...</td></tr>
        </tbody>
    </table>

    <div id="loadingIndicator">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©...</div>

    <script>
        let logAllMessages = [];
        const botNamesLog = ['mrbeefbot', 'nightbot', 'streamelements'];
        let isFetching = false;
        let initialLoadComplete = false;

        // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„ØªÙƒØ±Ø§Ø± ---
        function getSystemTimeOnlyLog(dateTimeStr) {
            if (!dateTimeStr) return "--:--";
            try {
                const date = new Date(dateTimeStr);
                if (isNaN(date.getTime())) return "--:--";
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            } catch (e) { return "--:--"; }
        }
         function filterByTimeLog(msg, from, to) {
            if (!from && !to) return true;
            const msgTime = getSystemTimeOnlyLog(msg[0]);
            if (msgTime === "--:--") return true;
            if (from && msgTime < from) return false;
            if (to && msgTime > to) return false;
            return true;
        }
         function getMessageUniqueIdLog(msg) {
            if (!msg || typeof msg !== 'object' || msg.length < 4) return null;
            const systemTime = msg[0] || ''; const userName = msg[2] || 'unknown';
            const textPart = (msg[3] || '').substring(0, 50);
            return `${systemTime}_${userName}_${textPart}`;
        }
         function deduplicateMessagesLog(messages) {
            if(!Array.isArray(messages)) return [];
            const uniqueMessages = new Map();
            messages.forEach(msg => { const id = getMessageUniqueIdLog(msg); if (id) { uniqueMessages.set(id, msg); } });
            return Array.from(uniqueMessages.values());
        }
        // ---------------------------

        // --- Ø¯Ø§Ù„Ø© Ø§Ù„ØªØµØ¯ÙŠØ± ---
        function exportLogToExcel() {
            const tableBody = document.getElementById("messages_table_log");
            const countSpan = document.getElementById("messageCountLog");
            if (!tableBody) return;

            const tableToExport = document.createElement('table');
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `<th>ÙˆÙ‚Øª Ø§Ù„Ù†Ø¸Ø§Ù…</th><th>ÙˆÙ‚Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>`;
            thead.appendChild(headerRow);
            tableToExport.appendChild(thead);

            // **Ù…Ù‡Ù…:** ÙŠØ¬Ø¨ Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ ÙˆÙ„ÙŠØ³ ÙÙ‚Ø· Ù…Ø§ Ù‡Ùˆ Ø¸Ø§Ù‡Ø±
            const nameFilter = document.getElementById("logUserSearch").value.toLowerCase();
            const fromTime = document.getElementById("logFromTime").value;
            const toTime = document.getElementById("logToTime").value;
            const filteredData = logAllMessages.filter(msg =>
                 (msg && msg[2] && msg[2].toLowerCase().includes(nameFilter)) &&
                 filterByTimeLog(msg, fromTime, toTime) &&
                 (msg[3] !== undefined && msg[3] !== null)
            );

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØµØ¯ÙŠØ± (Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„ØµØ­ÙŠØ­ØŒ Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹)
            const tbodyExport = document.createElement('tbody');
            filteredData.forEach(msg => { // Ù„Ø§ Ù†Ø¹ÙƒØ³ Ø§Ù„ØªØ±ØªÙŠØ¨ Ù‡Ù†Ø§
                 const row = document.createElement('tr');
                 row.innerHTML = `
                    <td>${msg[0] || ''}</td>
                    <td>${msg[1] || '--:--'}</td>
                    <td>${msg[2] || 'Unknown'}</td>
                    <td>${msg[3] || ''}</td>
                `;
                tbodyExport.appendChild(row);
            });
            tableToExport.appendChild(tbodyExport);


            const wb = XLSX.utils.table_to_book(tableToExport, { sheet: "ChatLog" });
            // Ø§Ø³Ù… Ù…Ù„Ù Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù…Ø¹ ØªØ§Ø±ÙŠØ® (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            const dateStr = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `kick_chat_log_${dateStr}.xlsx`);
        }
        // --------------------

        // --- Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ---
        function renderLogTable() {
            const tableBody = document.getElementById("messages_table_log");
            const countSpan = document.getElementById("messageCountLog");
            if (!tableBody || !countSpan) return;

            const nameFilter = document.getElementById("logUserSearch").value.toLowerCase();
            const fromTime = document.getElementById("logFromTime").value;
            const toTime = document.getElementById("logToTime").value;

            const filteredData = logAllMessages.filter(msg =>
                 (msg && msg[2] && msg[2].toLowerCase().includes(nameFilter)) &&
                 filterByTimeLog(msg, fromTime, toTime) &&
                 (msg[3] !== undefined && msg[3] !== null)
            );

            tableBody.innerHTML = '';

            if (filteredData.length === 0 && initialLoadComplete) {
                tableBody.innerHTML = '<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«.</td></tr>';
            } else if (filteredData.length === 0 && !initialLoadComplete) {
                 tableBody.innerHTML = '<tr><td colspan="4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</td></tr>';
            } else {
                // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø§Ù„Ø£Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰)
                filteredData.slice().reverse().forEach(msg => {
                    const isBot = botNamesLog.includes(msg[2]?.toLowerCase() || '');
                    const row = document.createElement('tr');
                    row.className = isBot ? 'bot-message' : '';
                    row.innerHTML = `
                        <td class="timestamp">${msg[0] || ''}</td>
                        <td class="timestamp">${msg[1] || '--:--'}</td>
                        <td class="username">${msg[2] || 'Unknown'}</td>
                        <td class="message">${msg[3] || ''}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
            countSpan.textContent = `(${filteredData.length}) Ø±Ø³Ø§Ù„Ø©`;
        }

        // --- Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ---
        function fetchNewLogMessages() {
            if (isFetching || !initialLoadComplete) { return; }

            isFetching = true;
            const loadingIndicator = document.getElementById('loadingIndicator');
            if(loadingIndicator) loadingIndicator.style.display = 'block';

            fetch('/get_new_messages')
                .then(res => { if (!res.ok) throw new Error(`HTTP ${res.status}`); return res.json(); })
                .then(newMessages => {
                    if (newMessages && Array.isArray(newMessages) && newMessages.length > 0) {
                        const combined = logAllMessages.concat(newMessages);
                        const uniqueCombined = deduplicateMessagesLog(combined);

                        if (uniqueCombined.length > logAllMessages.length) {
                            logAllMessages = uniqueCombined;
                            // **ÙÙ‚Ø· Ø£Ø¹Ø¯ Ø§Ù„Ø±Ø³Ù… Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„ÙÙ„ØªØ±Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§**
                            // Ù‡Ø°Ø§ ÙŠÙ…Ù†Ø¹ Ù‚ÙØ² Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙÙ„ØªØ±Ø©
                            const userSearchActive = document.getElementById("logUserSearch")?.value?.length > 0;
                            const fromTimeActive = document.getElementById("logFromTime")?.value?.length > 0;
                            const toTimeActive = document.getElementById("logToTime")?.value?.length > 0;
                            if (!userSearchActive && !fromTimeActive && !toTimeActive) {
                                 renderLogTable(); // Ø£Ø¹Ø¯ Ø§Ù„Ø±Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                            } else {
                                 // ÙÙ‚Ø· Ø­Ø¯Ø« Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                                 const countSpan = document.getElementById("messageCountLog");
                                 if(countSpan) countSpan.textContent = `(${uniqueCombined.length}) Ø±Ø³Ø§Ù„Ø© (Ù‚Ø¯ ØªØ®ØªÙ„Ù Ø¹Ù† Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ø¨Ø³Ø¨Ø¨ Ø§Ù„ÙÙ„ØªØ±Ø©)`;
                                 console.log("New messages arrived, but filtering is active. Table not fully re-rendered.");
                            }
                        }
                    }
                })
                .catch(error => console.error("Error fetching new messages:", error))
                .finally(() => { if(loadingIndicator) loadingIndicator.style.display = 'none'; isFetching = false; });
        }

        // --- Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ---
        document.addEventListener('DOMContentLoaded', () => {
            // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ù…Ù† localStorage
             if (localStorage.getItem("darkMode") === "yes") { document.body.classList.add("dark-mode"); }

            console.log("Starting initial fetch for all messages...");
            fetch('/get_all_messages')
                .then(res => { if (!res.ok) throw new Error(`HTTP ${res.status}`); return res.json(); })
                .then(data => {
                    logAllMessages = Array.isArray(data) ? deduplicateMessagesLog(data) : [];
                    initialLoadComplete = true;
                    renderLogTable(); // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ

                    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø§Ù„ÙÙ„Ø§ØªØ± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
                    const userSearch = document.getElementById("logUserSearch");
                    const fromInput = document.getElementById("logFromTime");
                    const toInput = document.getElementById("logToTime");
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø£ÙŠ ÙÙ„ØªØ±
                    if(userSearch) userSearch.addEventListener("input", renderLogTable);
                    if(fromInput) fromInput.addEventListener("input", renderLogTable);
                    if(toInput) toInput.addEventListener("input", renderLogTable);

                    // Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    console.log("Starting periodic fetching for new messages...");
                    // *** ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØµÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø¥Ù„Ù‰ 0.5 Ø«Ø§Ù†ÙŠØ© ***
                    setInterval(fetchNewLogMessages, 500); // 500 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©
                    // ****************************************
                })
                .catch(error => {
                    console.error("Fatal error during initial load:", error);
                    const tableBody = document.getElementById("messages_table_log");
                    const countSpan = document.getElementById("messageCountLog");
                    if(tableBody) tableBody.innerHTML = '<tr><td colspan="4">Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„.</td></tr>';
                    if(countSpan) countSpan.textContent = 'Ø®Ø·Ø£';
                    initialLoadComplete = true; // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¯ÙˆØ±ÙŠØ©
                    // Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
                    console.log("Starting periodic fetching despite error...");
                    // *** ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØµÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø¥Ù„Ù‰ 0.5 Ø«Ø§Ù†ÙŠØ© ***
                    setInterval(fetchNewLogMessages, 500); // 500 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©
                    // ****************************************
                });
        });
         // Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ (ÙŠÙ…ÙƒÙ† Ù†Ø³Ø®Ù‡Ø§ Ù…Ù† index.html)
         function toggleDarkMode() {
             document.body.classList.toggle("dark-mode");
             const isDarkMode = document.body.classList.contains("dark-mode");
             localStorage.setItem("darkMode", isDarkMode ? "yes" : "no");
             // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ØªØ­Ø¯ÙŠØ« Ù„Ù†Øµ Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ ÙˆØ§Ø­Ø¯ Ù‡Ù†Ø§
         }
            let latestId = 0;

            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ù„Ù„ØµÙØ­Ø©
            fetch('/get_all_messages')
                .then(res => res.json())
                .then(data => {
                data.forEach(msg => {
                    addMessageToTable(msg);
                    if (msg.id > latestId) latestId = msg.id;
                });
                });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙƒÙ„ Ø«Ø§Ù†ÙŠØªÙŠÙ†
            setInterval(() => {
                fetch(`/get_new_messages?after=${latestId}`)
                .then(res => res.json())
                .then(newMessages => {
                    newMessages.forEach(msg => {
                    addMessageToTable(msg);
                    if (msg.id > latestId) latestId = msg.id;
                    });
                });
            }, 2000);

            // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¬Ø¯ÙˆÙ„
            function addMessageToTable(msg) {
                const table = document.getElementById("messagesTable").getElementsByTagName('tbody')[0];
                const row = table.insertRow(-1);

                row.insertCell(0).innerText = msg.system_time;
                row.insertCell(1).innerText = msg.time_sent;
                row.insertCell(2).innerText = msg.username;
                row.insertCell(3).innerText = msg.message;
            }
    </script>
    <script>
  let latestId = 0;

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©
  fetch('/get_all_messages')
    .then(res => res.json())
    .then(data => {
      data.forEach(msg => {
        addMessageToTable(msg);
        if (msg.id > latestId) latestId = msg.id;
      });
    });

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙƒÙ„ Ø«Ø§Ù†ÙŠØªÙŠÙ†
  setInterval(() => {
    fetch(`/get_new_messages?after=${latestId}`)
      .then(res => res.json())
      .then(newMessages => {
        newMessages.forEach(msg => {
          addMessageToTable(msg);
          if (msg.id > latestId) latestId = msg.id;
        });
      });
  }, 2000);

  // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¬Ø¯ÙˆÙ„
  function addMessageToTable(msg) {
    const table = document.getElementById("messagesTable").getElementsByTagName('tbody')[0];
    const row = table.insertRow(-1);
    row.insertCell(0).innerText = msg.system_time;
    row.insertCell(1).innerText = msg.time_sent;
    row.insertCell(2).innerText = msg.username;
    row.insertCell(3).innerText = msg.message;
  }
</script>
    <script>
  let latestId = null;

  // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
  fetch('/get_all_messages')
    .then(res => res.json())
    .then(data => {
      data.forEach(msg => {
        addMessageToTable(msg);
        latestId = msg.id;
      });
    });

  // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙƒÙ„ Ø«Ø§Ù†ÙŠØªÙŠÙ†
  setInterval(() => {
    if (!latestId) return;
    fetch(`/get_new_messages?after=${latestId}`)
      .then(res => res.json())
      .then(newMessages => {
        newMessages.forEach(msg => {
          addMessageToTable(msg);
          latestId = msg.id;
        });
      });
  }, 2000);

  function addMessageToTable(msg) {
    const table = document.getElementById("messagesTable").getElementsByTagName('tbody')[0];
    const row = table.insertRow(-1);
    row.insertCell(0).innerText = msg.system_time;
    row.insertCell(1).innerText = msg.time_sent;
    row.insertCell(2).innerText = msg.username;
    row.insertCell(3).innerText = msg.message;
  }
</script>

</body>
</html>
