<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>سجل الرسائل</title>
    <!-- رابط لملف CSS خارجي (اختياري) -->
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"> -->
     <style>
        /* --- أنماط مشابهة لـ index.html --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction: rtl; background-color: #f0f2f5; color: #333; padding: 20px; margin: 0; }
        h1, h2 { text-align: center; color: #2c3e50; }
        .main-table { width: 100%; margin: 20px auto; background-color: #fff; border-collapse: collapse; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden; }
        .main-table th, .main-table td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #eee; }
        .main-table tr:last-child td { border-bottom: none; }
        .main-table th { background-color: #3498db; color: white; font-weight: 600; position: sticky; top: 0; z-index: 1; } /* جعل الرأس ثابتًا عند التمرير */
        td.username { font-weight: bold; color: #2980b9; }
        td.message { white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; text-align: right; padding-right: 15px; padding-left: 15px; }
        .timestamp { color: #7f8c8d; font-size: 0.85em; white-space: nowrap; }
        .bot-message td { background-color: #f8f9f9; color: #c0392b; font-style: italic; }

         /* --- الوضع الليلي --- */
         body.dark-mode { background-color: #1e272e; color: #ecf0f1; }
         body.dark-mode h1, body.dark-mode h2 { color: #ecf0f1; }
         body.dark-mode .main-table { background-color: #2c3e50; color: #ecf0f1; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
         body.dark-mode .main-table th { background-color: #34495e !important; color: #ecf0f1; }
         body.dark-mode .main-table td { border-bottom-color: #34495e; }
         body.dark-mode tr:last-child td { border-bottom: none; }
         body.dark-mode a { color: #5dade2; } /* لون الرابط في الوضع الليلي */
         body.dark-mode a:hover { color: #85c1e9; }
         body.dark-mode .timestamp { color: #95a5a6; }
         body.dark-mode .bot-message td { background-color: #34495e; color: #e74c3c; }

         /* --- زر العودة --- */
         .back-button { display: inline-block; margin: 20px 10px 0 0; padding: 10px 25px; background-color: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; text-decoration: none; text-align: center; }
         .back-button:hover { background-color: #7f8c8d; color: white;}
         body.dark-mode .back-button { background-color: #7f8c8d; }
         body.dark-mode .back-button:hover { background-color: #95a5a6; color: white;}

         /* --- فلاتر السجل --- */
         .log-filters { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; padding: 10px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
         .log-filters input { padding: 8px 12px; border-radius: 5px; font-size: 1em; border: 1px solid #ccc; min-width: 150px; }
         body.dark-mode .log-filters { background-color: #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
         body.dark-mode .log-filters input { background-color: #34495e; color: #ecf0f1; border-color: #4a6378; }
         body.dark-mode .log-filters input::placeholder { color: #bdc3c7; }

         /* --- زر تصدير السجل --- */
         .export-log-button { padding: 10px 20px; background-color: #16a085; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; }
         .export-log-button:hover { background-color: #117a65; }
         body.dark-mode .export-log-button { background-color: #1abc9c; }
         body.dark-mode .export-log-button:hover { background-color: #16a085; }

         /* --- مؤشر التحميل --- */
         #loadingIndicator { text-align: center; padding: 10px; color: #888; font-style: italic; display: none; /* مخفي افتراضيًا */ }
         body.dark-mode #loadingIndicator { color: #aaa; }

         /* --- شريط العنوان --- */
         .title-bar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; padding-bottom: 15px; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
         .title-bar h1 { margin: 0; flex-grow: 1; text-align: right; } /* العنوان يأخذ المساحة المتاحة */
         .title-bar .button-group { display: flex; gap: 10px; } /* مجموعة الأزرار */
          body.dark-mode .title-bar { border-bottom-color: #34495e; }

    </style>
    <!-- إضافة مكتبة Excel للتصدير -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body> <!-- لا حاجة لتطبيق الكلاس هنا، سيتم تطبيقه بواسطة JS -->
    <div class="title-bar">
         <div class="button-group">
             <a href="/" class="back-button">🔙 العودة</a>
             <button onclick="exportLogToExcel()" class="export-log-button">📁 تصدير السجل</button>
         </div>
         <h1 style="margin-bottom: 10px;">سجل الرسائل</h1>
         <div style="min-width: 150px; text-align: left;"> <!-- مساحة فارغة للموازنة أو وضع عناصر أخرى -->
              <span id="messageCountLog" style="font-weight: bold; color: #555;">(تحميل...)</span>
         </div>
    </div>

     <div class="log-filters">
        <input type="text" id="logUserSearch" placeholder="بحث باسم المستخدم..." aria-label="بحث باسم المستخدم"/>
        <input type="time" id="logFromTime" aria-label="من وقت"/>
        <input type="time" id="logToTime" aria-label="إلى وقت"/>
      </div>

    <table class="main-table" id="messagesTableLog">
        <thead>
            <tr>
                <th>وقت النظام</th>
                <th>وقت الرسالة</th>
                <th>المستخدم</th>
                <th>الرسالة</th>
            </tr>
        </thead>
        <tbody id="messages_table_log">
             <tr><td colspan="4">جاري تحميل الرسائل الأولية...</td></tr>
        </tbody>
    </table>

    <div id="loadingIndicator">جاري البحث عن رسائل جديدة...</div>

    <script>
        let logAllMessages = [];
        const botNamesLog = ['mrbeefbot', 'nightbot', 'streamelements'];
        let isFetching = false;
        let initialLoadComplete = false;

        // --- دوال الفلترة والتكرار ---
        function getSystemTimeOnlyLog(dateTimeStr) {
            if (!dateTimeStr) return "--:--";
            try {
                const date = new Date(dateTimeStr);
                if (isNaN(date.getTime())) return "--:--";
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            } catch (e) { return "--:--"; }
        }
         function filterByTimeLog(msg, from, to) {
            if (!from && !to) return true;
            const msgTime = getSystemTimeOnlyLog(msg[0]);
            if (msgTime === "--:--") return true;
            if (from && msgTime < from) return false;
            if (to && msgTime > to) return false;
            return true;
        }
         function getMessageUniqueIdLog(msg) {
            if (!msg || typeof msg !== 'object' || msg.length < 4) return null;
            const systemTime = msg[0] || ''; const userName = msg[2] || 'unknown';
            const textPart = (msg[3] || '').substring(0, 50);
            return `${systemTime}_${userName}_${textPart}`;
        }
         function deduplicateMessagesLog(messages) {
            if(!Array.isArray(messages)) return [];
            const uniqueMessages = new Map();
            messages.forEach(msg => { const id = getMessageUniqueIdLog(msg); if (id) { uniqueMessages.set(id, msg); } });
            return Array.from(uniqueMessages.values());
        }
        // ---------------------------

        // --- دالة التصدير ---
        function exportLogToExcel() {
            const tableBody = document.getElementById("messages_table_log");
            const countSpan = document.getElementById("messageCountLog");
            if (!tableBody) return;

            const tableToExport = document.createElement('table');
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `<th>وقت النظام</th><th>وقت الرسالة</th><th>المستخدم</th><th>الرسالة</th>`;
            thead.appendChild(headerRow);
            tableToExport.appendChild(thead);

            // **مهم:** يجب نسخ البيانات المفلترة الحالية، وليس فقط ما هو ظاهر
            const nameFilter = document.getElementById("logUserSearch").value.toLowerCase();
            const fromTime = document.getElementById("logFromTime").value;
            const toTime = document.getElementById("logToTime").value;
            const filteredData = logAllMessages.filter(msg =>
                 (msg && msg[2] && msg[2].toLowerCase().includes(nameFilter)) &&
                 filterByTimeLog(msg, fromTime, toTime) &&
                 (msg[3] !== undefined && msg[3] !== null)
            );

            // إضافة الصفوف المفلترة إلى جدول التصدير (بالترتيب الزمني الصحيح، الأقدم أولاً)
            const tbodyExport = document.createElement('tbody');
            filteredData.forEach(msg => { // لا نعكس الترتيب هنا
                 const row = document.createElement('tr');
                 row.innerHTML = `
                    <td>${msg[0] || ''}</td>
                    <td>${msg[1] || '--:--'}</td>
                    <td>${msg[2] || 'Unknown'}</td>
                    <td>${msg[3] || ''}</td>
                `;
                tbodyExport.appendChild(row);
            });
            tableToExport.appendChild(tbodyExport);


            const wb = XLSX.utils.table_to_book(tableToExport, { sheet: "ChatLog" });
            // اسم ملف ديناميكي مع تاريخ (اختياري)
            const dateStr = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `kick_chat_log_${dateStr}.xlsx`);
        }
        // --------------------

        // --- دالة عرض الجدول ---
        function renderLogTable() {
            const tableBody = document.getElementById("messages_table_log");
            const countSpan = document.getElementById("messageCountLog");
            if (!tableBody || !countSpan) return;

            const nameFilter = document.getElementById("logUserSearch").value.toLowerCase();
            const fromTime = document.getElementById("logFromTime").value;
            const toTime = document.getElementById("logToTime").value;

            const filteredData = logAllMessages.filter(msg =>
                 (msg && msg[2] && msg[2].toLowerCase().includes(nameFilter)) &&
                 filterByTimeLog(msg, fromTime, toTime) &&
                 (msg[3] !== undefined && msg[3] !== null)
            );

            tableBody.innerHTML = '';

            if (filteredData.length === 0 && initialLoadComplete) {
                tableBody.innerHTML = '<tr><td colspan="4">لا توجد رسائل تطابق البحث.</td></tr>';
            } else if (filteredData.length === 0 && !initialLoadComplete) {
                 tableBody.innerHTML = '<tr><td colspan="4">جاري تحميل الرسائل...</td></tr>';
            } else {
                // عرض الرسائل (الأحدث في الأعلى)
                filteredData.slice().reverse().forEach(msg => {
                    const isBot = botNamesLog.includes(msg[2]?.toLowerCase() || '');
                    const row = document.createElement('tr');
                    row.className = isBot ? 'bot-message' : '';
                    row.innerHTML = `
                        <td class="timestamp">${msg[0] || ''}</td>
                        <td class="timestamp">${msg[1] || '--:--'}</td>
                        <td class="username">${msg[2] || 'Unknown'}</td>
                        <td class="message">${msg[3] || ''}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            // تحديث عدد الرسائل المعروضة
            countSpan.textContent = `(${filteredData.length}) رسالة`;
        }

        // --- دالة جلب الرسائل الجديدة ---
        function fetchNewLogMessages() {
            if (isFetching || !initialLoadComplete) { return; }

            isFetching = true;
            const loadingIndicator = document.getElementById('loadingIndicator');
            if(loadingIndicator) loadingIndicator.style.display = 'block';

            fetch('/get_new_messages')
                .then(res => { if (!res.ok) throw new Error(`HTTP ${res.status}`); return res.json(); })
                .then(newMessages => {
                    if (newMessages && Array.isArray(newMessages) && newMessages.length > 0) {
                        const combined = logAllMessages.concat(newMessages);
                        const uniqueCombined = deduplicateMessagesLog(combined);

                        if (uniqueCombined.length > logAllMessages.length) {
                            logAllMessages = uniqueCombined;
                            // **فقط أعد الرسم إذا لم يكن المستخدم يقوم بالفلترة حاليًا**
                            // هذا يمنع قفز الجدول أثناء الكتابة في حقول الفلترة
                            const userSearchActive = document.getElementById("logUserSearch")?.value?.length > 0;
                            const fromTimeActive = document.getElementById("logFromTime")?.value?.length > 0;
                            const toTimeActive = document.getElementById("logToTime")?.value?.length > 0;
                            if (!userSearchActive && !fromTimeActive && !toTimeActive) {
                                 renderLogTable(); // أعد الرسم بالكامل
                            } else {
                                 // فقط حدث عدد الرسائل الإجمالي (اختياري)
                                 const countSpan = document.getElementById("messageCountLog");
                                 if(countSpan) countSpan.textContent = `(${uniqueCombined.length}) رسالة (قد تختلف عن المعروض بسبب الفلترة)`;
                                 console.log("New messages arrived, but filtering is active. Table not fully re-rendered.");
                            }
                        }
                    }
                })
                .catch(error => console.error("Error fetching new messages:", error))
                .finally(() => { if(loadingIndicator) loadingIndicator.style.display = 'none'; isFetching = false; });
        }

        // --- عند تحميل الصفحة ---
        document.addEventListener('DOMContentLoaded', () => {
            // استعادة الوضع الليلي من localStorage
             if (localStorage.getItem("darkMode") === "yes") { document.body.classList.add("dark-mode"); }

            console.log("Starting initial fetch for all messages...");
            fetch('/get_all_messages')
                .then(res => { if (!res.ok) throw new Error(`HTTP ${res.status}`); return res.json(); })
                .then(data => {
                    logAllMessages = Array.isArray(data) ? deduplicateMessagesLog(data) : [];
                    initialLoadComplete = true;
                    renderLogTable(); // عرض الجدول الأولي

                    // ربط الأحداث بالفلاتر بعد التحميل الأولي
                    const userSearch = document.getElementById("logUserSearch");
                    const fromInput = document.getElementById("logFromTime");
                    const toInput = document.getElementById("logToTime");
                    // إعادة الرسم عند تغيير أي فلتر
                    if(userSearch) userSearch.addEventListener("input", renderLogTable);
                    if(fromInput) fromInput.addEventListener("input", renderLogTable);
                    if(toInput) toInput.addEventListener("input", renderLogTable);

                    // بدء الجلب الدوري للرسائل الجديدة
                    console.log("Starting periodic fetching for new messages...");
                    // *** تعديل الفاصل الزمني إلى 0.5 ثانية ***
                    setInterval(fetchNewLogMessages, 500); // 500 مللي ثانية
                    // ****************************************
                })
                .catch(error => {
                    console.error("Fatal error during initial load:", error);
                    const tableBody = document.getElementById("messages_table_log");
                    const countSpan = document.getElementById("messageCountLog");
                    if(tableBody) tableBody.innerHTML = '<tr><td colspan="4">خطأ فادح في تحميل السجل.</td></tr>';
                    if(countSpan) countSpan.textContent = 'خطأ';
                    initialLoadComplete = true; // السماح بمحاولات الجلب الدورية
                    // بدء الجلب الدوري حتى لو فشل التحميل الأولي
                    console.log("Starting periodic fetching despite error...");
                    // *** تعديل الفاصل الزمني إلى 0.5 ثانية ***
                    setInterval(fetchNewLogMessages, 500); // 500 مللي ثانية
                    // ****************************************
                });
        });
         // دالة تبديل الوضع الليلي (يمكن نسخها من index.html)
         function toggleDarkMode() {
             document.body.classList.toggle("dark-mode");
             const isDarkMode = document.body.classList.contains("dark-mode");
             localStorage.setItem("darkMode", isDarkMode ? "yes" : "no");
             // يمكنك إضافة تحديث لنص زر التبديل إذا كان لديك واحد هنا
         }
            let latestId = 0;

            // تحميل الرسائل القديمة عند أول تحميل للصفحة
            fetch('/get_all_messages')
                .then(res => res.json())
                .then(data => {
                data.forEach(msg => {
                    addMessageToTable(msg);
                    if (msg.id > latestId) latestId = msg.id;
                });
                });

            // تحديث الرسائل الجديدة كل ثانيتين
            setInterval(() => {
                fetch(`/get_new_messages?after=${latestId}`)
                .then(res => res.json())
                .then(newMessages => {
                    newMessages.forEach(msg => {
                    addMessageToTable(msg);
                    if (msg.id > latestId) latestId = msg.id;
                    });
                });
            }, 2000);

            // دالة لإضافة صف جديد للجدول
            function addMessageToTable(msg) {
                const table = document.getElementById("messagesTable").getElementsByTagName('tbody')[0];
                const row = table.insertRow(-1);

                row.insertCell(0).innerText = msg.system_time;
                row.insertCell(1).innerText = msg.time_sent;
                row.insertCell(2).innerText = msg.username;
                row.insertCell(3).innerText = msg.message;
            }
    </script>
    <script>
  let latestId = 0;

  // تحميل الرسائل القديمة عند بداية الصفحة
  fetch('/get_all_messages')
    .then(res => res.json())
    .then(data => {
      data.forEach(msg => {
        addMessageToTable(msg);
        if (msg.id > latestId) latestId = msg.id;
      });
    });

  // تحديث الرسائل الجديدة كل ثانيتين
  setInterval(() => {
    fetch(`/get_new_messages?after=${latestId}`)
      .then(res => res.json())
      .then(newMessages => {
        newMessages.forEach(msg => {
          addMessageToTable(msg);
          if (msg.id > latestId) latestId = msg.id;
        });
      });
  }, 2000);

  // دالة لإضافة صف جديد للجدول
  function addMessageToTable(msg) {
    const table = document.getElementById("messagesTable").getElementsByTagName('tbody')[0];
    const row = table.insertRow(-1);
    row.insertCell(0).innerText = msg.system_time;
    row.insertCell(1).innerText = msg.time_sent;
    row.insertCell(2).innerText = msg.username;
    row.insertCell(3).innerText = msg.message;
  }
</script>
    <script>
  let latestId = null;

  // تحميل أولي للرسائل عند فتح الصفحة
  fetch('/get_all_messages')
    .then(res => res.json())
    .then(data => {
      data.forEach(msg => {
        addMessageToTable(msg);
        latestId = msg.id;
      });
    });

  // تحديث تلقائي للرسائل الجديدة كل ثانيتين
  setInterval(() => {
    if (!latestId) return;
    fetch(`/get_new_messages?after=${latestId}`)
      .then(res => res.json())
      .then(newMessages => {
        newMessages.forEach(msg => {
          addMessageToTable(msg);
          latestId = msg.id;
        });
      });
  }, 2000);

  function addMessageToTable(msg) {
    const table = document.getElementById("messagesTable").getElementsByTagName('tbody')[0];
    const row = table.insertRow(-1);
    row.insertCell(0).innerText = msg.system_time;
    row.insertCell(1).innerText = msg.time_sent;
    row.insertCell(2).innerText = msg.username;
    row.insertCell(3).innerText = msg.message;
  }
</script>

</body>
</html>
