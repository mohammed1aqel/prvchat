<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ø³Ø¬Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</title>
    <!-- Ø±Ø§Ø¨Ø· Ù„Ù…Ù„Ù CSS Ø®Ø§Ø±Ø¬ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) -->
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"> -->
     <style>
        /* --- Ø£Ù†Ù…Ø§Ø· Ù…Ø´Ø§Ø¨Ù‡Ø© Ù„Ù€ index.html --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction: rtl; background-color: #f0f2f5; color: #333; padding: 20px; margin: 0; }
        h1, h2 { text-align: center; color: #2c3e50; }
        .main-table { width: 100%; margin: 20px auto; background-color: #fff; border-collapse: collapse; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden; }
        .main-table th, .main-table td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #eee; }
        .main-table tr:last-child td { border-bottom: none; }
        .main-table th { background-color: #3498db; color: white; font-weight: 600; position: sticky; top: 0; z-index: 1; } /* Ø¬Ø¹Ù„ Ø§Ù„Ø±Ø£Ø³ Ø«Ø§Ø¨ØªÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        td.username { font-weight: bold; color: #2980b9; }
        td.message { white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; text-align: right; padding-right: 15px; padding-left: 15px; }
        .timestamp { color: #7f8c8d; font-size: 0.85em; white-space: nowrap; }
        .bot-message td { background-color: #f8f9f9; color: #c0392b; font-style: italic; }

         /* --- Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ --- */
         body.dark-mode { background-color: #1e272e; color: #ecf0f1; }
         body.dark-mode h1, body.dark-mode h2 { color: #ecf0f1; }
         body.dark-mode .main-table { background-color: #2c3e50; color: #ecf0f1; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
         body.dark-mode .main-table th { background-color: #34495e !important; color: #ecf0f1; }
         body.dark-mode .main-table td { border-bottom-color: #34495e; }
         body.dark-mode tr:last-child td { border-bottom: none; }
         body.dark-mode a { color: #5dade2; } /* Ù„ÙˆÙ† Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
         body.dark-mode a:hover { color: #85c1e9; }
         body.dark-mode .timestamp { color: #95a5a6; }
         body.dark-mode .bot-message td { background-color: #34495e; color: #e74c3c; }

         /* --- Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© --- */
         .back-button { display: inline-block; margin: 20px 10px 0 0; padding: 10px 25px; background-color: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; text-decoration: none; text-align: center; }
         .back-button:hover { background-color: #7f8c8d; color: white;}
         body.dark-mode .back-button { background-color: #7f8c8d; }
         body.dark-mode .back-button:hover { background-color: #95a5a6; color: white;}

         /* --- ÙÙ„Ø§ØªØ± Ø§Ù„Ø³Ø¬Ù„ --- */
         .log-filters { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; padding: 10px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
         .log-filters input { padding: 8px 12px; border-radius: 5px; font-size: 1em; border: 1px solid #ccc; min-width: 150px; }
         body.dark-mode .log-filters { background-color: #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
         body.dark-mode .log-filters input { background-color: #34495e; color: #ecf0f1; border-color: #4a6378; }
         body.dark-mode .log-filters input::placeholder { color: #bdc3c7; }

         /* --- Ø²Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„ --- */
         .export-log-button { padding: 10px 20px; background-color: #16a085; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; }
         .export-log-button:hover { background-color: #117a65; }
         body.dark-mode .export-log-button { background-color: #1abc9c; }
         body.dark-mode .export-log-button:hover { background-color: #16a085; }

         /* --- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ --- */
         #loadingIndicator { text-align: center; padding: 10px; color: #888; font-style: italic; display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ */ }
         body.dark-mode #loadingIndicator { color: #aaa; }

         /* --- Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† --- */
         .title-bar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; padding-bottom: 15px; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
         .title-bar h1 { margin: 0; flex-grow: 1; text-align: right; } /* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙŠØ£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© */
         .title-bar .button-group { display: flex; gap: 10px; } /* Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
          body.dark-mode .title-bar { border-bottom-color: #34495e; }

    </style>
    <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© Excel Ù„Ù„ØªØµØ¯ÙŠØ± -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body> <!-- Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙƒÙ„Ø§Ø³ Ù‡Ù†Ø§ØŒ Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© JS -->
    <div class="title-bar">
         <div class="button-group">
             <a href="/" class="back-button">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©</a>
             <button onclick="exportLogToExcel()" class="export-log-button">ğŸ“ ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„</button>
             <!-- ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª -->
             <!-- <button onclick="toggleDarkMode()">ğŸŒ™ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹</button> -->
         </div>
         <h1 style="margin-bottom: 10px;">Ø³Ø¬Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h1>
         <div style="min-width: 150px; text-align: left;"> <!-- Ù…Ø³Ø§Ø­Ø© ÙØ§Ø±ØºØ© Ù„Ù„Ù…ÙˆØ§Ø²Ù†Ø© Ø£Ùˆ ÙˆØ¶Ø¹ Ø¹Ù†Ø§ØµØ± Ø£Ø®Ø±Ù‰ -->
              <span id="messageCountLog" style="font-weight: bold; color: #555;">(ØªØ­Ù…ÙŠÙ„...)</span>
         </div>
    </div>

     <div class="log-filters">
        <input type="text" id="logUserSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..." aria-label="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"/>
        <input type="time" id="logFromTime" aria-label="Ù…Ù† ÙˆÙ‚Øª"/>
        <input type="time" id="logToTime" aria-label="Ø¥Ù„Ù‰ ÙˆÙ‚Øª"/>
      </div>

    <table class="main-table" id="messagesTableLog">
        <thead>
            <tr>
                <th>ÙˆÙ‚Øª Ø§Ù„Ù†Ø¸Ø§Ù…</th>
                <th>ÙˆÙ‚Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                <th>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>
            </tr>
        </thead>
        <tbody id="messages_table_log">
             <tr><td colspan="4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©...</td></tr>
        </tbody>
    </table>

    <div id="loadingIndicator">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©...</div>

    <script>
        // *** ASSUMPTION: Server sends data as an array of objects: ***
        // [
        //   { system_time: "ISO_String_Or_Comparable", time_sent: "HH:MM", username: "...", message: "..." },
        //   ...
        // ]
        // *** AND `/get_new_messages` accepts a `?since=TIMESTAMP` parameter ***

        let logAllMessages = [];
        const botNamesLog = ['mrbeefbot', 'nightbot', 'streamelements'];
        let isFetching = false;
        let initialLoadComplete = false;
        let latestTimestamp = null; // Ù„ØªØªØ¨Ø¹ Ø¢Ø®Ø± Ø·Ø§Ø¨Ø¹ Ø²Ù…Ù†ÙŠ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù…Ù‡
        let fetchIntervalId = null; // Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¤Ù‚Øª

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        function getSystemTimeOnlyLog(dateTimeStr) {
            // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ³ØªØ®Ø±Ø¬ ÙÙ‚Ø· HH:MM Ù…Ù† ÙˆÙ‚Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª
            if (!dateTimeStr) return "--:--";
            try {
                const date = new Date(dateTimeStr);
                if (isNaN(date.getTime())) return "--:--";
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            } catch (e) { return "--:--"; }
        }

        function formatSystemTimeForDisplay(dateTimeStr) {
             // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ ÙˆÙ‚Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø´ÙƒÙ„ Ù…Ù‚Ø±ÙˆØ¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
             if (!dateTimeStr) return "N/A";
             try {
                 const date = new Date(dateTimeStr);
                 if (isNaN(date.getTime())) return "Invalid Date";
                 // ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ù‡Ù†Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©
                 return date.toLocaleString('ar-EG'); // Ù…Ø«Ø§Ù„: ØªÙ†Ø³ÙŠÙ‚ Ù…ØµØ±ÙŠ
             } catch (e) { return "Error"; }
        }

        function filterByTimeLog(msg, from, to) {
            if (!from && !to) return true;
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆÙ‚Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„ÙÙ„ØªØ±Ø©
            const msgTime = getSystemTimeOnlyLog(msg.system_time); // <-- Accessing object property
            if (msgTime === "--:--") return true; // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¯ÙˆÙ† ÙˆÙ‚Øª ØµØ§Ù„Ø­
            if (from && msgTime < from) return false;
            if (to && msgTime > to) return false;
            return true;
        }

        function getMessageUniqueIdLog(msg) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®ØµØ§Ø¦Øµ Ø§Ù„ÙƒØ§Ø¦Ù† Ù„ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯
            if (!msg || typeof msg !== 'object') return null;
            const systemTime = msg.system_time || '';
            const userName = msg.username || 'unknown';
            const textPart = (msg.message || '').substring(0, 50);
            // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ ID Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ù‹Ø§ ÙˆÙ…ÙˆØ«ÙˆÙ‚Ù‹Ø§
            return `${systemTime}_${userName}_${textPart}`;
        }

        function deduplicateMessagesLog(messages) {
            if (!Array.isArray(messages)) return [];
            const uniqueMessages = new Map();
            messages.forEach(msg => {
                const id = getMessageUniqueIdLog(msg);
                if (id) { uniqueMessages.set(id, msg); }
            });
            return Array.from(uniqueMessages.values());
        }

        // --- Ø¯Ø§Ù„Ø© Ø§Ù„ØªØµØ¯ÙŠØ± ---
        function exportLogToExcel() {
            const tableBody = document.getElementById("messages_table_log");
            const countSpan = document.getElementById("messageCountLog");
            if (!tableBody) return;

            const tableToExport = document.createElement('table');
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØµØ­ÙŠØ­Ø©
            headerRow.innerHTML = `<th>ÙˆÙ‚Øª Ø§Ù„Ù†Ø¸Ø§Ù…</th><th>ÙˆÙ‚Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>`;
            thead.appendChild(headerRow);
            tableToExport.appendChild(thead);

            // ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ logAllMessages ÙˆØ§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            const nameFilter = document.getElementById("logUserSearch").value.toLowerCase();
            const fromTime = document.getElementById("logFromTime").value;
            const toTime = document.getElementById("logToTime").value;

            const filteredData = logAllMessages.filter(msg =>
                 msg && // Check if msg exists
                 (msg.username && msg.username.toLowerCase().includes(nameFilter)) && // <-- Accessing object property
                 filterByTimeLog(msg, fromTime, toTime) &&
                 (msg.message !== undefined && msg.message !== null) // <-- Accessing object property
            );

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…ÙÙ„ØªØ±Ø© (Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ù„Ù)
            const tbodyExport = document.createElement('tbody');
            filteredData // Ù„Ø§ Ù†Ø¹ÙƒØ³ Ø§Ù„ØªØ±ØªÙŠØ¨ Ù‡Ù†Ø§ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø²Ù…Ù†ÙŠ ÙÙŠ Ø§Ù„Ù…Ù„Ù
                .sort((a, b) => new Date(a.system_time) - new Date(b.system_time)) // ÙØ±Ø² Ø­Ø³Ø¨ ÙˆÙ‚Øª Ø§Ù„Ù†Ø¸Ø§Ù… ØªØµØ§Ø¹Ø¯ÙŠØ§Ù‹
                .forEach(msg => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatSystemTimeForDisplay(msg.system_time) || ''}</td>
                        <td>${msg.time_sent || '--:--'}</td>
                        <td>${msg.username || 'Unknown'}</td>
                        <td>${msg.message || ''}</td>
                    `;
                    tbodyExport.appendChild(row);
                });
            tableToExport.appendChild(tbodyExport);

            const wb = XLSX.utils.table_to_book(tableToExport, { sheet: "ChatLog" });
            const dateStr = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `kick_chat_log_${dateStr}.xlsx`);
        }

        // --- Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ---
        function renderLogTable() {
            const tableBody = document.getElementById("messages_table_log");
            const countSpan = document.getElementById("messageCountLog");
            if (!tableBody || !countSpan) return;

            const nameFilter = document.getElementById("logUserSearch").value.toLowerCase();
            const fromTime = document.getElementById("logFromTime").value;
            const toTime = document.getElementById("logToTime").value;

            // ÙÙ„ØªØ±Ø© logAllMessages Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙÙ„Ø§ØªØ±
            const filteredData = logAllMessages.filter(msg =>
                 msg &&
                 (msg.username && msg.username.toLowerCase().includes(nameFilter)) && // <-- Accessing object property
                 filterByTimeLog(msg, fromTime, toTime) &&
                 (msg.message !== undefined && msg.message !== null) // <-- Accessing object property
            );

            tableBody.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù…

            if (filteredData.length === 0 && initialLoadComplete) {
                tableBody.innerHTML = '<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«.</td></tr>';
            } else if (filteredData.length === 0 && !initialLoadComplete) {
                 tableBody.innerHTML = '<tr><td colspan="4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</td></tr>';
            } else {
                // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø§Ù„Ø£Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶)
                // ÙØ±Ø² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹) - Ù†Ø³Ø®Ø© Ù…ÙØ±ÙˆØ²Ø© Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
                const sortedForDisplay = filteredData.slice().sort((a, b) => {
                     // ÙØ±Ø² ØªÙ†Ø§Ø²Ù„ÙŠ Ø­Ø³Ø¨ ÙˆÙ‚Øª Ø§Ù„Ù†Ø¸Ø§Ù…
                     const dateA = new Date(a.system_time || 0);
                     const dateB = new Date(b.system_time || 0);
                     return dateB - dateA;
                });

                sortedForDisplay.forEach(msg => {
                    const isBot = botNamesLog.includes(msg.username?.toLowerCase() || ''); // <-- Accessing object property
                    const row = document.createElement('tr');
                    row.className = isBot ? 'bot-message' : '';
                    row.innerHTML = `
                        <td class="timestamp">${formatSystemTimeForDisplay(msg.system_time) || ''}</td>
                        <td class="timestamp">${msg.time_sent || '--:--'}</td>
                        <td class="username">${msg.username || 'Unknown'}</td>
                        <td class="message">${msg.message || ''}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©/Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
            countSpan.textContent = `(${filteredData.length} / ${logAllMessages.length}) Ø±Ø³Ø§Ù„Ø©`;
        }

        // --- Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ---
        function fetchNewLogMessages() {
            if (isFetching || !initialLoadComplete) { return; }

            isFetching = true;
            const loadingIndicator = document.getElementById('loadingIndicator');
            if(loadingIndicator) loadingIndicator.style.display = 'block';

            // **ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø±Ø³Ø§Ù„ Ø¢Ø®Ø± Ø·Ø§Ø¨Ø¹ Ø²Ù…Ù†ÙŠ Ù„Ù„Ø®Ø§Ø¯Ù…**
            const fetchUrl = `/get_new_messages${latestTimestamp ? '?since=' + encodeURIComponent(latestTimestamp) : ''}`;
            console.log("Fetching new messages from:", fetchUrl); // Ù„Ù„ØªØµØ­ÙŠØ­

            fetch(fetchUrl)
                .then(res => {
                    if (!res.ok) {
                         // Ø¹Ø±Ø¶ Ø®Ø·Ø£ Ø£ÙƒØ«Ø± ØªÙØµÙŠÙ„Ø§Ù‹
                         return res.text().then(text => { throw new Error(`HTTP ${res.status}: ${text || res.statusText}`) });
                    }
                    // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙØ§Ø±ØºØ© (Ù…Ø«Ù„ 204 No Content) Ù‚Ø¨Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù„ÙŠÙ„ JSON
                    if (res.status === 204) {
                       return []; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯ØŒ Ø£Ø±Ø¬Ø¹ Ù…ØµÙÙˆÙØ© ÙØ§Ø±ØºØ©
                    }
                    return res.json();
                })
                .then(newMessages => {
                    if (newMessages && Array.isArray(newMessages) && newMessages.length > 0) {
                        console.log(`Received ${newMessages.length} new messages.`); // Ù„Ù„ØªØµØ­ÙŠØ­

                        // Ø¯Ù…Ø¬ ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±
                        const combined = logAllMessages.concat(newMessages);
                        const uniqueCombined = deduplicateMessagesLog(combined);

                        if (uniqueCombined.length > logAllMessages.length) {
                            logAllMessages = uniqueCombined;

                            // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø·Ø§Ø¨Ø¹ Ø²Ù…Ù†ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©
                            const newLatest = newMessages.reduce((latest, msg) => {
                                const msgTime = msg.system_time;
                                return msgTime && (!latest || msgTime > latest) ? msgTime : latest;
                            }, latestTimestamp); // Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„

                            if (newLatest > latestTimestamp) {
                                latestTimestamp = newLatest;
                                console.log("Updated latestTimestamp:", latestTimestamp); // Ù„Ù„ØªØµØ­ÙŠØ­
                            }

                            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„ÙÙ„Ø§ØªØ± Ù†Ø´Ø·Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù‚ÙØ²
                            const userSearchActive = document.getElementById("logUserSearch")?.value?.length > 0;
                            const fromTimeActive = document.getElementById("logFromTime")?.value?.length > 0;
                            const toTimeActive = document.getElementById("logToTime")?.value?.length > 0;

                            if (!userSearchActive && !fromTimeActive && !toTimeActive) {
                                 renderLogTable(); // Ø£Ø¹Ø¯ Ø§Ù„Ø±Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                            } else {
                                 // Ø­Ø¯Ø« Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙ‚Ø·
                                 const countSpan = document.getElementById("messageCountLog");
                                 if (countSpan) countSpan.textContent = `(${document.getElementById("messages_table_log").rows.length} / ${logAllMessages.length}) Ø±Ø³Ø§Ù„Ø© (Ù…Ø±Ø´Ø­Ø©)`;
                                 console.log("New messages arrived, but filtering is active. Table not fully re-rendered.");
                            }
                        } else {
                             console.log("No genuinely new unique messages after deduplication."); // Ù„Ù„ØªØµØ­ÙŠØ­
                        }
                    } else {
                         console.log("No new messages received or empty array."); // Ù„Ù„ØªØµØ­ÙŠØ­
                    }
                })
                .catch(error => console.error("Error fetching new messages:", error)) // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®Ø·Ø£
                .finally(() => {
                    if(loadingIndicator) loadingIndicator.style.display = 'none';
                    isFetching = false;
                 });
        }

        // --- Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ---
        document.addEventListener('DOMContentLoaded', () => {
            // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
            if (localStorage.getItem("darkMode") === "yes") { document.body.classList.add("dark-mode"); }

            console.log("Starting initial fetch for all messages...");
            fetch('/get_all_messages')
                .then(res => {
                    if (!res.ok) {
                         return res.text().then(text => { throw new Error(`HTTP ${res.status}: ${text || res.statusText}`) });
                    }
                     // ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„
                     const contentType = res.headers.get("content-type");
                     if (contentType && contentType.indexOf("application/json") !== -1) {
                         return res.json();
                     } else {
                         // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† JSONØŒ Ø±Ø¨Ù…Ø§ ÙŠÙƒÙˆÙ† Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ùˆ ØµÙØ­Ø© HTML
                         throw new Error('Received non-JSON response from /get_all_messages');
                     }
                })
                .then(data => {
                    if (!Array.isArray(data)) {
                        console.error("Initial data is not an array:", data);
                        throw new Error("Invalid data format received from server.");
                    }
                    logAllMessages = deduplicateMessagesLog(data); // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©

                    // ØªØ­Ø¯ÙŠØ¯ Ø¢Ø®Ø± Ø·Ø§Ø¨Ø¹ Ø²Ù…Ù†ÙŠ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
                    latestTimestamp = logAllMessages.reduce((latest, msg) => {
                         const msgTime = msg.system_time;
                         // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† msgTime Ù…ÙˆØ¬ÙˆØ¯ ÙˆØ£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù€ latest Ø§Ù„Ø­Ø§Ù„ÙŠ
                         return msgTime && (!latest || msgTime > latest) ? msgTime : latest;
                     }, null); // Ø§Ø¨Ø¯Ø£ Ø¨Ù€ null
                    console.log("Initial latestTimestamp:", latestTimestamp); // Ù„Ù„ØªØµØ­ÙŠØ­

                    initialLoadComplete = true;
                    renderLogTable(); // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ

                    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø§Ù„ÙÙ„Ø§ØªØ± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ ÙˆØ§Ù„Ù†Ø§Ø¬Ø­
                    const userSearch = document.getElementById("logUserSearch");
                    const fromInput = document.getElementById("logFromTime");
                    const toInput = document.getElementById("logToTime");

                    if(userSearch) userSearch.addEventListener("input", renderLogTable);
                    if(fromInput) fromInput.addEventListener("input", renderLogTable);
                    if(toInput) toInput.addEventListener("input", renderLogTable);

                    // Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø§Ù„Ù†Ø§Ø¬Ø­
                    console.log("Starting periodic fetching for new messages...");
                    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯
                    if (fetchIntervalId) clearInterval(fetchIntervalId);
                    fetchIntervalId = setInterval(fetchNewLogMessages, 1000); // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙØ§ØµÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø¥Ù„Ù‰ Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø© ÙƒÙ…Ø«Ø§Ù„

                })
                .catch(error => {
                    console.error("Fatal error during initial load:", error); // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø®Ø·Ø£
                    const tableBody = document.getElementById("messages_table_log");
                    const countSpan = document.getElementById("messageCountLog");
                    if(tableBody) tableBody.innerHTML = `<tr><td colspan="4">Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„: ${error.message}. ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù… ÙˆÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ….</td></tr>`;
                    if(countSpan) countSpan.textContent = 'Ø®Ø·Ø£';
                    // Ù„Ø§ ØªØ¨Ø¯Ø£ Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø¨Ø´ÙƒÙ„ ÙØ§Ø¯Ø­
                    // initialLoadComplete = true; // ÙŠÙ…ÙƒÙ† ØªØ±ÙƒÙ‡Ø§ false Ù„Ù…Ù†Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„ÙØ§Ø´Ù„Ø©
                });
        });

        // --- Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ ---
        function toggleDarkMode() {
             document.body.classList.toggle("dark-mode");
             const isDarkMode = document.body.classList.contains("dark-mode");
             localStorage.setItem("darkMode", isDarkMode ? "yes" : "no");
        }

    </script>

    <!-- ØªÙ… Ø­Ø°Ù ÙƒØªÙ„Ø© Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ -->

</body>
</html>
