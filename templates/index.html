<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Øª</title>
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; padding: 10px 20px; background-color: #fff; border-bottom: 1px solid #ddd;">
    <h1 style="margin: 0; color: #2c3e50;">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Øª</h1>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
         <button onclick="exportUsersToExcel()" class="header-button-base header-button--color-users">
          ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
         </button>
         <button onclick="openModeratorModal()" class="header-button-base header-button--color-mods">
            ğŸ›¡ï¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†
         </button>
         <!-- *** ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø²Ø±: Ù„Ù… ÙŠØ¹Ø¯ ÙŠÙ…Ø³Ø­ localStorageØŒ Ø¨Ù„ Ø±Ø¨Ù…Ø§ ÙŠÙ†Ø¨Ù‡ ÙÙ‚Ø· *** -->
         <button onclick="showClearWarning()" class="header-button-base header-button--color-clear" title="Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ù† Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…. Ù‡Ø°Ø§ Ø§Ù„Ø²Ø± Ù„Ù„Ø¹Ù„Ù… ÙÙ‚Ø·.">
           ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª (Ù…Ø¹Ø·Ù„)
         </button>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* ... (Ù†ÙØ³ Ø£Ù†Ù…Ø§Ø· CSS Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±) ... */

    /* --- Ø£Ù†Ù…Ø§Ø· Ù…Ø´Ø§Ø¨Ù‡Ø© Ù„Ù€ index.html --- */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction: rtl; background-color: #f0f2f5; color: #333; padding: 0; margin: 0; }
    h1, h2 { text-align: center; color: #2c3e50; }
    .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
    label { display: block; text-align: center; margin-top: 20px; font-weight: bold; }

    /* --- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ÙˆØ£Ø²Ø±Ø§Ø±Ù‡ --- */
     div[style*="background-color: #fff"] { /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
     }
    .header-button-base {
        color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;
        transition: background-color 0.2s ease, transform 0.1s ease; font-weight: 500;
        display: inline-block; vertical-align: middle; text-align: center;
    }
    .header-button-base:active { transform: scale(0.98); }
    .header-button--color-users { background-color: #2980b9; }
    .header-button--color-users:hover { background-color: #1f618d; }
    .header-button--color-mods { background-color: #8e44ad; }
    .header-button--color-mods:hover { background-color: #732d91; }
    /* ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø²Ø± Ø§Ù„Ù…Ø³Ø­ Ù„ÙŠØ¯Ù„ Ø¹Ù„Ù‰ Ø£Ù†Ù‡ Ù…Ø¹Ø·Ù„ Ø£Ùˆ Ù…Ø®ØªÙ„Ù */
    .header-button--color-clear { background-color: #bdc3c7; cursor: not-allowed; }
    .header-button--color-clear:hover { background-color: #95a5a6; }


    /* --- Ø§Ù„ÙÙ„Ø§ØªØ± --- */
    .filters { display: flex; justify-content: center; gap: 10px; margin-top: 10px; flex-wrap: wrap; padding: 10px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .filters input, .filters button { padding: 8px 12px; border-radius: 5px; font-size: 1em; border: 1px solid #ccc; }
    .filters input { min-width: 150px; }
    #resetFilters { background-color: #e74c3c; color: white; border: none; }
    #resetFilters:hover { background-color: #c0392b; }

    /* --- Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ --- */
    .mini-table, .main-table { width: 100%; margin: 20px auto; background-color: #fff; border-collapse: collapse; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden; }
    .mini-table th, .mini-table td, .main-table th, .main-table td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #eee; }
    .mini-table tr:last-child td, .main-table tr:last-child td { border-bottom: none; }
    .mini-table th { background-color: #27ae60; color: white; font-weight: 600; }
    .main-table th { background-color: #3498db; color: white; font-weight: 600; } /* Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†ÙˆØ§ÙØ° */
    td a { color: inherit; text-decoration: none; font-weight: bold; }
    td a:hover { text-decoration: underline; color: #3498db; }
    .timestamp { color: #7f8c8d; font-size: 0.85em; white-space: nowrap; }
    #userStatsTable tbody tr:hover td { background-color: #f5f5f5; cursor: pointer; transition: background-color 0.15s ease-in-out; } /* ØªØ¸Ù„ÙŠÙ„ ØµÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
    #userStatsTable tbody tr:hover td a:hover { text-decoration: none; }

    /* --- Ù…ÙØªØ§Ø­ Ø§Ù„Ø­Ø§Ù„Ø© --- */
    .status-hint { padding: 10px; background-color: #e9ecef; border-radius: 5px; border: 1px solid #dee2e6; margin-bottom: 15px; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
    .status-hint strong { color: #343a40; }
    .status-hint span { display: inline-block; margin: 5px 10px; }

    /* --- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ --- */
    .user-display-controls button { background-color: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 0 5px; transition: background-color 0.2s ease; }
    .user-display-controls button:hover { background-color: #2980b9; }
    .user-display-controls button#decreaseUsersBtn { background-color: #e74c3c; }
    .user-display-controls button#decreaseUsersBtn:hover { background-color: #c0392b; }
    .user-display-controls button#toggleUsersBtn { background-color: #8e44ad; }
    .user-display-controls button#toggleUsersBtn:hover { background-color: #732d91; }

    /* --- Ø²Ø± Ø±Ø§Ø¨Ø· Ø³Ø¬Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ --- */
    .show-log-btn {
        display: inline-block; /* Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„Ø­Ø´Ùˆ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ */
        padding: 10px 25px; font-size: 1em; background-color: #3498db; color: white;
        border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease;
        text-decoration: none; /* Ø¥Ø²Ø§Ù„Ø© Ø®Ø· Ø§Ù„Ø±Ø§Ø¨Ø· */
    }
    .show-log-btn:hover { background-color: #2980b9; color: white; }

    /* --- Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© --- */
    #userMessagesModal, #moderatorModal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0, 0, 0, 0.6); align-items: center; justify-content: center; }
    .modal-content { background-color: #fefefe; margin: auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 1000px; max-height: 85vh; overflow-y: auto; border-radius: 10px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .fixed-close { position: fixed; top: 20px; left: 20px; z-index: 1100; background-color: #e74c3c; color: white; border: none; border-radius: 50%; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.3); width: 40px; height: 40px; font-size: 1.4em; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1; }
    .fixed-close:hover { background-color: #c0392b; }
    .fixed-close:active { transform: scale(0.95); }

    /* --- Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ --- */
    body.dark-mode { background-color: #1e272e; color: #ecf0f1; }
    body.dark-mode h1, body.dark-mode h2 { color: #ecf0f1; }
    body.dark-mode div[style*="background-color: #fff"] { background-color: #2c3e50 !important; border-bottom-color: #34495e; }
    body.dark-mode div[style*="background-color: #fff"] h1 { color: #ecf0f1; }
    body.dark-mode .filters { background-color: #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    body.dark-mode .mini-table, body.dark-mode .main-table, body.dark-mode .modal-content { background-color: #2c3e50; color: #ecf0f1; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
    body.dark-mode th { background-color: #34495e !important; color: #ecf0f1; }
    body.dark-mode td { border-bottom-color: #34495e; }
    body.dark-mode tr:last-child td { border-bottom: none; }
    body.dark-mode input, body.dark-mode .filters button { background-color: #34495e; color: #ecf0f1; border-color: #4a6378; }
    body.dark-mode input::placeholder { color: #bdc3c7; }
    body.dark-mode #resetFilters { background-color: #c0392b; color: white; border: none; }
    body.dark-mode #resetFilters:hover { background-color: #e74c3c; }
    body.dark-mode a { color: #5dade2; }
    body.dark-mode a:hover { color: #85c1e9; }
    body.dark-mode .timestamp { color: #95a5a6; }
    body.dark-mode #userStatsTable tbody tr:hover td { background-color: #3a5064; }
    body.dark-mode #userStatsTable tbody tr:hover td a:hover { text-decoration: none; }
    body.dark-mode .status-hint { background-color: #34495e; border-color: #4a6378; color: #bdc3c7; }
    body.dark-mode .status-hint strong { color: #ecf0f1; }
    body.dark-mode .user-display-controls button { background-color: #5dade2; }
    body.dark-mode .user-display-controls button:hover { background-color: #3498db; }
    body.dark-mode .user-display-controls button#decreaseUsersBtn { background-color: #e74c3c; }
    body.dark-mode .user-display-controls button#decreaseUsersBtn:hover { background-color: #c0392b; }
    body.dark-mode .user-display-controls button#toggleUsersBtn { background-color: #9b59b6; }
    body.dark-mode .user-display-controls button#toggleUsersBtn:hover { background-color: #8e44ad; }
    body.dark-mode .show-log-btn { background-color: #5dade2; color: white; }
    body.dark-mode .show-log-btn:hover { background-color: #3498db; color: white;}
    body.dark-mode .header-button--color-users { background-color: #3498db; }
    body.dark-mode .header-button--color-users:hover { background-color: #2980b9; }
    body.dark-mode .header-button--color-mods { background-color: #9b59b6; }
    body.dark-mode .header-button--color-mods:hover { background-color: #8e44ad; }
    /* ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø²Ø± Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…Ø¹Ø·Ù„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    body.dark-mode .header-button--color-clear { background-color: #7f8c8d; cursor: not-allowed; }
    body.dark-mode .header-button--color-clear:hover { background-color: #95a5a6;}
    #darkModeToggle { transition: background-color 0.2s ease, color 0.2s ease; }
    body.dark-mode #darkModeToggle { background-color: #f1c40f; color: #333; }
    body.dark-mode #darkModeToggle:hover { background-color: #f39c12; }

     /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ù„ÙŠØ© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠØ¯ÙˆÙŠ - Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ */
    .manual-date-cell.editable {
        background-color: #fffacd; /* Ø£ØµÙØ± ÙØ§ØªØ­ */
        cursor: text;
        outline: none;
        border: 1px dashed #ccc;
    }
    .manual-date-cell.editable:focus {
        background-color: #ffffff;
        border: 1px solid #aaa;
        box-shadow: 0 0 3px rgba(0,0,0,0.2);
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ù„ÙŠØ© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠØ¯ÙˆÙŠ - ØºÙŠØ± Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ */
    .manual-date-cell.not-editable {
        background-color: #f8f9fa; /* Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ Ø¬Ø¯Ù‹Ø§ */
        color: #555;
        cursor: default; /* Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠ */
        font-style: italic; /* Ø¬Ø¹Ù„Ù‡Ø§ Ù…Ø§Ø¦Ù„Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) */
    }

    /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    body.dark-mode .manual-date-cell.editable {
        background-color: #5a5a35;
        color: #eee;
        border-color: #666;
    }
    body.dark-mode .manual-date-cell.editable:focus {
        background-color: #444;
        border-color: #888;
        box-shadow: 0 0 3px rgba(255,255,255,0.1);
    }
    body.dark-mode .manual-date-cell.not-editable {
        background-color: #3a4b5b; /* Ø£Ø²Ø±Ù‚ Ø±Ù…Ø§Ø¯ÙŠ Ø£ØºÙ…Ù‚ */
        color: #bdc3c7;
        font-style: italic;
    }
        /* ... (Ø¨Ù‚ÙŠØ© CSS) ... */

    /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ù„ÙŠØ© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠØ¯ÙˆÙŠ */
        /* ... (Ø¨Ù‚ÙŠØ© CSS) ... */

    /* ØªØ¹Ø¯ÙŠÙ„ Ù„Ø£Ù†Ù…Ø§Ø· Ø®Ù„ÙŠØ© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠØ¯ÙˆÙŠ */
    .manual-date-cell {
        position: relative; /* Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨ØªÙ…ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…Ø·Ù„Ù‚ */
        min-width: 170px;
        padding: 10px 8px !important; /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø´Ùˆ Ù„ÙŠÙ„Ø§Ø¦Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
    }
    .manual-date-cell .date-display { /* Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ù„Ù„ØªØ§Ø±ÙŠØ® */
        display: inline-block; /* Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ù…Ø­Ø§Ø°Ø§Ø© Ù…Ø¹ Ø§Ù„Ø²Ø± */
        min-width: 100px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® */
        text-align: center; /* Ø£Ùˆ right Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª */
         font-style: italic; /* ØªÙ…ÙŠÙŠØ² Ø§Ù„ØªØ§Ø±ÙŠØ® Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
         color: #555;
    }
    .manual-date-cell .date-input { /* Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® */
        display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ */
        width: calc(100% - 35px); /* ÙŠØ£Ø®Ø° Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ§Ø­ Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø²Ø± */
        box-sizing: border-box;
        padding: 4px 6px;
        border: 1px solid #ccc;
        border-radius: 3px;
    }
     /* Ø¹Ù†Ø¯ Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ØŒ Ù†Ø®ÙÙŠ Ø§Ù„Ù†Øµ */
    .manual-date-cell.editing .date-display { display: none; }
    .manual-date-cell.editing .date-input { display: inline-block; }

    .edit-date-btn { /* Ø²Ø±/Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
        background: none;
        border: none;
        color: #888;
        cursor: pointer;
        font-size: 0.9em;
        padding: 0 5px;
        margin-right: 5px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ù†Øµ/Ø§Ù„Ø­Ù‚Ù„ */
        vertical-align: middle; /* Ù…Ø­Ø§Ø°Ø§Ø© Ø±Ø£Ø³ÙŠØ© */
        display: inline-block; /* Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ø¸Ø§Ù‡Ø± Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® */
    }
     .edit-date-btn:hover { color: #333; }
     /* Ù†Ø®ÙÙŠ Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ */
     .manual-date-cell.editing .edit-date-btn { display: none; }

     /* Ø¬Ø¹Ù„ Ø§Ù„Ø®Ù„ÙŠØ© ØºÙŠØ± Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ØªØ¨Ø¯Ùˆ Ù…Ø®ØªÙ„ÙØ© */
     .manual-date-cell.not-editable .edit-date-btn { display: none; } /* Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
     .manual-date-cell.not-editable .date-display { font-style: normal; color: #555; } /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ù…Ø§Ù„Ø© */


    /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    body.dark-mode .manual-date-cell .date-display { color: #bdc3c7; }
    body.dark-mode .manual-date-cell .date-input { background-color: #34495e; color: #ecf0f1; border-color: #4a6378; }
    body.dark-mode .edit-date-btn { color: #aaa; }
    body.dark-mode .edit-date-btn:hover { color: #eee; }
     body.dark-mode .manual-date-cell.not-editable .date-display { color: #bdc3c7; font-style: normal;}

  </style>
</head>
<body>
  <div class="container">
    <div style="text-align: left; padding: 10px 0;">
      <button onclick="toggleDarkMode()" id="darkModeToggle" style="padding: 8px 16px; background-color: #444; color: #fff; border: none; border-radius: 5px; cursor: pointer;">
        ğŸŒ™ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
      </button>
    </div>

    <label for="userSearch">ğŸ” ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</label>
    <div class="filters">
      <input type="text" id="userSearch" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" aria-label="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"/>
      <input type="time" id="fromTime" aria-label="Ù…Ù† ÙˆÙ‚Øª"/>
      <input type="time" id="toTime" aria-label="Ø¥Ù„Ù‰ ÙˆÙ‚Øª"/>
      <button id="resetFilters">ğŸ§¹ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
    </div>

    <table class="mini-table" id="userStatsTable">
      <thead>
        <tr>
          <!-- *** Ø³Ù†Ø­ØªØ§Ø¬ Ù„ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ù† JavaScript Ø¨Ø¹Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª *** -->
          <th colspan="7" id="userCountHeader" style="background-color: #2ecc71;">
            Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...)
          </th>
        </tr>
        <tr>
          <th>#</th>
          <th>ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
          <th>ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</th>
          <th>â±ï¸ Ù…Ø¯Ø© Ø§Ù„ØªÙˆØ§Ø¬Ø¯</th>
          <th>ğŸ• Ø£ÙˆÙ„ Ø¸Ù‡ÙˆØ±</th>
          <th>ğŸ•“ Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±</th>
          <th>ğŸ”„ Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr>
      </thead>
      <!-- *** Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø³Ù… Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript Ø¨Ø¹Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª *** -->
      <tbody id="userStatsTableBody">
          <tr><td colspan="7">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</td></tr>
      </tbody>
    </table>

    <div class="status-hint" style="text-align: center; margin-top: 15px; font-size: 0.9em; color: #555;">
        <p style="margin: 5px 0;"><strong>ğŸ’¡ Ù…ÙØªØ§Ø­ Ø§Ù„Ø­Ø§Ù„Ø©:</strong></p>
        <span style="margin: 0 10px;">ğŸŸ¢ Ù…ØªÙˆØ§Ø¬Ø¯ Ø§Ù„Ø¢Ù† (Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø° Ø£Ù‚Ù„ Ù…Ù† Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†)</span>
        <span style="margin: 0 10px;">ğŸŸ¡ ØªÙˆØ§Ø¬Ø¯ Ù…Ù†Ø° Ù‚Ù„ÙŠÙ„ (Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø° 2-5 Ø¯Ù‚Ø§Ø¦Ù‚)</span>
        <span style="margin: 0 10px;">ğŸ”´ ØºÙŠØ± Ù…ØªÙˆØ§Ø¬Ø¯ (Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø° Ø£ÙƒØ«Ø± Ù…Ù† 5 Ø¯Ù‚Ø§Ø¦Ù‚)</span>
    </div>

    <div style="text-align:center; margin-top: 15px; margin-bottom: 20px;" class="user-display-controls">
      <button onclick="increaseUsers()">
        â• Ø¹Ø±Ø¶ 10 Ø¥Ø¶Ø§ÙÙŠÙŠÙ†
      </button>
      <button id="decreaseUsersBtn" onclick="decreaseUsers()" style="display: none;">
        â– Ø¥Ø®ÙØ§Ø¡ 10
      </button>
      <button onclick="toggleUsers()" id="toggleUsersBtn">
        ğŸ‘¥ Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
      </button>
    </div>


    <div style="text-align:center; margin-top: 20px; margin-bottom: 20px;">
      <a href="/log" class="show-log-btn">
        ğŸ“œ Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
      </a>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù… ØªØªØºÙŠØ± ÙƒØ«ÙŠØ±Ù‹Ø§ØŒ Ù„ÙƒÙ†Ù‡Ø§ Ø³ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ allMessages Ø§Ù„Ù…Ø¬Ù„ÙˆØ¨Ø©) -->
  <div id="userMessagesModal">
    <div class="modal-content">
      <button onclick="closeUserModal()" class="fixed-close" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ–</button>
      <h2 id="userMessagesTitle" style="text-align:center; margin-top: 0; margin-bottom: 15px;">Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
      <div class="filters" style="background: none; box-shadow: none; padding: 5px 0;">
        <input type="text" id="userSearchText" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..." aria-label="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„"/>
        <input type="time" id="userFromTime" aria-label="Ù…Ù† ÙˆÙ‚Øª"/>
        <input type="time" id="userToTime" aria-label="Ø¥Ù„Ù‰ ÙˆÙ‚Øª"/>
      </div>
      <table class="main-table" style="margin-top: 15px;">
        <thead>
          <tr>
            <th>ÙˆÙ‚Øª Ø§Ù„Ù†Ø¸Ø§Ù…</th>
            <th>ÙˆÙ‚Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ù…Ø­ØªÙˆÙ‰</th>
          </tr>
        </thead>
        <tbody id="userMessagesTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† (Ù„Ù… ØªØªØºÙŠØ± ÙƒØ«ÙŠØ±Ù‹Ø§ØŒ Ø³ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ allMessages Ø§Ù„Ù…Ø¬Ù„ÙˆØ¨Ø©) -->
  <div id="moderatorModal">
    <div class="modal-content">
        <button onclick="closeModeratorModal()" class="fixed-close" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ–</button>
        <h2 style="text-align:center; margin-top: 0; margin-bottom: 20px;">ğŸ›¡ï¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</h2>
        <table class="main-table" id="moderatorStatusTable">
            <thead>
                <tr>
                    <th>ğŸ‘¤ Ø§Ù„Ù…Ø´Ø±Ù</th>
                    <th>ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</th>
                    <th>â±ï¸ Ù…Ø¯Ø© Ø§Ù„ØªÙˆØ§Ø¬Ø¯</th>
                    <th>ğŸ• Ø£ÙˆÙ„ Ø¸Ù‡ÙˆØ±</th>
                    <th>ğŸ•“ Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±</th>
                    <th>ğŸ”„ Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>ğŸ—“ï¸ Ø¢Ø®Ø± ØªÙˆØ§Ø¬Ø¯ (ÙŠØ¯ÙˆÙŠ)</th>
                </tr>
            </thead>
            <tbody id="moderator_status_table"></tbody>
        </table>
        <!-- Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ (ÙƒÙ…Ø§ Ù‡ÙŠ) -->
        <p style="text-align: center; font-size: 0.85em; color: #888; margin-top: 15px;">
            Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® "Ø¢Ø®Ø± ØªÙˆØ§Ø¬Ø¯ (ÙŠØ¯ÙˆÙŠ)" Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡. Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ Ù…ØªØµÙØ­Ùƒ (localStorage).
        </p>
        <p style="text-align: center; font-size: 0.85em; color: #e74c3c; margin-top: 5px;">
             ØªÙ†Ø¨ÙŠÙ‡: Ø³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ø¹Ù†Ø¯ Ù…Ø³Ø­ Ù…Ø­ÙÙˆØ¸Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± "Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª" (Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠÙ‚ÙˆÙ… Ø¨Ø°Ù„Ùƒ).
        </p>
        <!-- *** Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† Ù„Ø§ ØªØ²Ø§Ù„ ØªØ³ØªØ®Ø¯Ù… localStorage Ø­Ø³Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ. Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª ØªØºÙŠÙŠØ±Ù‡Ø§ Ù„ØªÙØ­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†ÙØµÙ„Ø©ØŒ Ø³ÙŠØªØ·Ù„Ø¨ Ø°Ù„Ùƒ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ÙÙŠ app.py Ùˆ JavaScript. *** -->
    </div>
</div>


  <!-- *** Ø¨Ø¯Ø§ÙŠØ© ÙˆØ³Ù… Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„ÙˆØ§Ø­Ø¯ (Ù…Ø¹Ø¯Ù„ Ø¨Ø´ÙƒÙ„ ÙƒØ¨ÙŠØ±) *** -->
  <script>
    // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
    let allMessages = []; // Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØºÙŠØ± Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
    let showAll = false;
    let currentUserForMessages = null;
    let visibleUserCount = 10;
    let openedFromModeratorModal = false;
    const botNames = ['mrbeefbot', 'nightbot', 'streamelements'];
    // *** Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù…ÙØªØ§Ø­ localStorage Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø¢Ù† ***
    // const STORAGE_KEY = 'kickChatMessages_hexawi';

    // Ù…ÙØªØ§Ø­ localStorage Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„ÙŠØ¯ÙˆÙŠØ© (ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ Ø­Ø§Ù„ÙŠÙ‹Ø§)
    const MOD_MANUAL_DATE_STORAGE_KEY = 'kickModManualDates_hexawi';
    const moderators = [
        'Dr_Bro', 'AlkhaaL_YouseF', 'AbderrezakSadi', 'CO_SNFORA',
        'co_nada', 'CO_Asalah', 'CoHager'
    ];

    // --- Ø¯ÙˆØ§Ù„ localStorage (ÙÙ‚Ø· Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„ÙŠØ¯ÙˆÙŠØ©) ---
    function saveManualModDates(manualDates) {
        try {
            localStorage.setItem(MOD_MANUAL_DATE_STORAGE_KEY, JSON.stringify(manualDates));
            console.log(`ğŸ’¾ ØªÙ… Ø­ÙØ¸ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„ÙŠØ¯ÙˆÙŠØ©.`);
        } catch (e) {
            console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„ÙŠØ¯ÙˆÙŠØ©:", e);
        }
    }

    function loadManualModDates() {
        try {
            const storedDates = localStorage.getItem(MOD_MANUAL_DATE_STORAGE_KEY);
            return storedDates ? JSON.parse(storedDates) || {} : {};
        } catch (e) {
            console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø§Ù„ÙŠØ¯ÙˆÙŠØ©:", e);
        }
        return {};
    }
    // --- *** ØªÙ… Ø­Ø°Ù Ø¯ÙˆØ§Ù„ save/load/clear Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø´Ø§Øª Ù…Ù† localStorage *** ---

    // --- Ø¯ÙˆØ§Ù„ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± ÙˆØ§Ù„Ù…Ø¹Ø±Ù Ø§Ù„ÙØ±ÙŠØ¯ (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠØŒ Ù…ÙÙŠØ¯Ø© Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©) ---
    function getMessageUniqueId(msg) {
        if (!msg || typeof msg !== 'object' || msg.length < 4) return null;
        const systemTime = msg[0] || ''; const userName = msg[2] || 'unknown';
        const textPart = (msg[3] || '').substring(0, 50);
        return `${systemTime}_${userName}_${textPart}`;
    }

    function deduplicateMessages(messages) { // Ù‚Ø¯ Ù„Ø§ Ù†Ø­ØªØ§Ø¬Ù‡Ø§ ÙƒØ«ÙŠØ±Ù‹Ø§ Ø§Ù„Ø¢Ù† Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¶Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±
        if(!Array.isArray(messages)) return [];
        const uniqueMessages = new Map();
        messages.forEach(msg => { const id = getMessageUniqueId(msg); if (id) { uniqueMessages.set(id, msg); } });
        return Array.from(uniqueMessages.values());
    }

    // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø£Ø®Ø±Ù‰ (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ) ---
    function getSystemTimeOnly(dateTimeStr) { /* ... Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ ... */
         if (!dateTimeStr) return "--:--"; try { const date = new Date(dateTimeStr); if (isNaN(date.getTime())) return "--:--"; const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; } catch (e) { return "--:--"; }
    }
    function exportUsersToExcel() { /* ... Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ ... */
        const table = document.querySelector("#userStatsTable"); if(!table) return; const tableToExport = document.createElement('table'); const header = table.querySelector('thead')?.cloneNode(true); const body = table.querySelector('tbody') ? table.querySelector('tbody').cloneNode(true) : document.createElement('tbody'); if(!header || !body) return; tableToExport.appendChild(header); tableToExport.appendChild(body); const userLinks = tableToExport.querySelectorAll('tbody td a'); userLinks.forEach(link => { const parentTd = link.parentNode; if(parentTd) { parentTd.textContent = link.textContent; } }); const wb = XLSX.utils.table_to_book(tableToExport, { sheet: "UserStats" }); XLSX.writeFile(wb, "user_stats.xlsx");
    }
    function filterByTime(msg, from, to) { /* ... Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ ... */
        if (!from && !to) return true; const msgTime = getSystemTimeOnly(msg[0]); if (msgTime === "--:--") return true; if (from && msgTime < from) return false; if (to && msgTime > to) return false; return true;
    }
    const calcEffectiveDuration = (times) => { /* ... Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ ... */
        if (!times || times.length === 0) return 0; times.sort((a, b) => a - b); let totalDurationMs = 0; if (times.length === 1) return 0; let sessionStart = times[0]; let lastMessageTime = times[0]; for (let i = 1; i < times.length; i++) { const currentTime = times[i]; const diffMinutes = (currentTime - lastMessageTime) / 60000; if (diffMinutes <= 5) { lastMessageTime = currentTime; } else { totalDurationMs += (lastMessageTime - sessionStart); sessionStart = currentTime; lastMessageTime = currentTime; } } totalDurationMs += (lastMessageTime - sessionStart); return totalDurationMs / 1000;
    };

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶ (Rendering) ---
    // Ø³ØªØ¹ØªÙ…Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… `allMessages` Ø§Ù„Ø°ÙŠ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±

    function updateUserStats() {
        // *** ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø¨Ø¹Ø¯ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ fetchInitialData Ø£Ùˆ fetchNewMessages ***
        const statsTableBody = document.getElementById("userStatsTableBody"); // Ø§Ø³ØªÙ‡Ø¯Ø§Ù Ø§Ù„Ø¬Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const userCountHeader = document.getElementById("userCountHeader");
        if (!statsTableBody || !userCountHeader) return;

        statsTableBody.innerHTML = ""; // Ù…Ø³Ø­ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡
        userCountHeader.textContent = "Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª..."; // Ø±Ø³Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ©

        // Ø§Ù„ÙÙ„Ø§ØªØ± ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ `allMessages` Ø§Ù„Ù…Ø¬Ù„ÙˆØ¨Ø©
        const nameFilter = document.getElementById("userSearch").value.toLowerCase();
        const fromTime = document.getElementById("fromTime").value;
        const toTime = document.getElementById("toTime").value;

        // ÙÙ„ØªØ±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        const filteredMessagesForStats = allMessages.filter(msg =>
            (msg && msg[2] && msg[2].toLowerCase().includes(nameFilter)) &&
            filterByTime(msg, fromTime, toTime) &&
            (msg[0] !== undefined && msg[0] !== null)
        );

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø§Ø¨Ù‚)
        const timestamps = {}; const counts = {};
        filteredMessagesForStats.forEach(msg => {
            const user = msg[2]; if (!msg[0]) return; try { const time = new Date(msg[0]); if (isNaN(time.getTime())) return; counts[user] = (counts[user] || 0) + 1; if (!timestamps[user]) timestamps[user] = []; timestamps[user].push(time); } catch (e) { console.error("Error processing message date for stats:", msg[0], e); }
        });

        const totalUserCount = Object.keys(counts).length;
        userCountHeader.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ† Ù„Ù„ÙÙ„ØªØ±): ${totalUserCount}`;
        let sortedUsers = Object.entries(counts).sort((a, b) => b[1] - a[1]);
        const usersToDisplay = showAll ? sortedUsers : sortedUsers.slice(0, visibleUserCount);

        if (usersToDisplay.length === 0) {
            statsTableBody.innerHTML = '<tr><td colspan="7">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙŠØ·Ø§Ø¨Ù‚ÙˆÙ† Ø§Ù„Ø¨Ø­Ø«.</td></tr>';
        } else {
            let index = 1;
            usersToDisplay.forEach(([user, count]) => {
                const userTimes = timestamps[user] || []; if (userTimes.length === 0) return;
                const totalSec = calcEffectiveDuration(userTimes); const durMinutes = Math.floor(totalSec / 60); const durSeconds = Math.floor(totalSec % 60); const firstTimeStr = userTimes[0].toLocaleTimeString('en-US'); const lastTimeObj = userTimes[userTimes.length - 1]; const lastTimeStr = lastTimeObj.toLocaleTimeString('en-US'); const now = new Date(); const sinceLastMs = now - lastTimeObj; const sinceLastTotalSeconds = Math.floor(sinceLastMs / 1000); const sinceMinutes = Math.floor(sinceLastTotalSeconds / 60); const sinceSeconds = sinceLastTotalSeconds % 60; let statusStr = ""; if (sinceMinutes < 2) { statusStr = "ğŸŸ¢ Ù…ØªÙˆØ§Ø¬Ø¯ Ø§Ù„Ø¢Ù†"; } else if (sinceMinutes < 5) { statusStr = "ğŸŸ¡ ØªÙˆØ§Ø¬Ø¯ Ù…Ù†Ø° Ù‚Ù„ÙŠÙ„"; } else { statusStr = `ğŸ”´ ØºÙŠØ± Ù…ØªÙˆØ§Ø¬Ø¯ (${sinceMinutes} Ø¯Ù‚ÙŠÙ‚Ø© ${sinceSeconds} Ø«Ø§Ù†ÙŠØ©)`; }
                const row = document.createElement("tr");
                row.innerHTML = `<td>${index++}</td><td><a href="#" onclick="openUserMessages('${user.replace(/'/g, "\\'")}')">${user}</a></td><td>${count}</td><td>${durMinutes} Ø¯Ù‚ÙŠÙ‚Ø© ${durSeconds} Ø«Ø§Ù†ÙŠØ©</td><td>${firstTimeStr}</td><td>${lastTimeStr}</td><td>${statusStr}</td>`;
                statsTableBody.appendChild(row);
            });
        }

        // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¹Ø±Ø¶ (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚)
        const decreaseBtn = document.getElementById("decreaseUsersBtn"); if (decreaseBtn) { decreaseBtn.style.display = (!showAll && visibleUserCount > 10) ? "inline-block" : "none"; }
        const toggleBtn = document.getElementById("toggleUsersBtn"); if (toggleBtn) { toggleBtn.textContent = showAll ? `ğŸ”™ Ø¹Ø±Ø¶ Ø£ÙˆÙ„ ${visibleUserCount}` : "ğŸ‘¥ Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"; }
    }

    function renderUserMessages(username) {
        // ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ `allMessages` Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        const tableBody = document.getElementById("userMessagesTable"); if (!tableBody) return;
        tableBody.innerHTML = ""; // Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø¯ÙŠÙ…
        const searchText = document.getElementById("userSearchText")?.value?.toLowerCase() || "";
        const fromTime = document.getElementById("userFromTime")?.value || "";
        const toTime = document.getElementById("userToTime")?.value || "";

        // ÙÙ„ØªØ±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† `allMessages`
        const userSpecificMessages = allMessages.filter(msg =>
            msg && msg[2] === username &&
            filterByTime(msg, fromTime, toTime) &&
            (msg[3] && msg[3].toLowerCase().includes(searchText))
        );

        if (userSpecificMessages.length === 0) {
             tableBody.innerHTML = '<tr><td colspan="3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø« Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….</td></tr>';
        } else {
            userSpecificMessages.slice().reverse().forEach(msg => {
                const row = document.createElement("tr");
                row.innerHTML = `<td class="timestamp">${msg[0] || ''}</td><td class="timestamp">${msg[1] || '--:--'}</td><td class="message">${msg[3] || ''}</td>`;
                tableBody.appendChild(row);
            });
        }
    }

    function renderModeratorStatus() {
        // ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ `allMessages` Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        const modTableBody = document.getElementById("moderator_status_table"); if (!modTableBody) return;
        modTableBody.innerHTML = ""; // Ù…Ø³Ø­ Ø§Ù„Ø¬Ø¯ÙˆÙ„

        const manualModDates = loadManualModDates(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ÙŠØ¯ÙˆÙŠØ© (Ù„Ø§ ØªØ²Ø§Ù„ Ù…Ù† localStorage)

        // Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ù…Ù† `allMessages` (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø§Ø¨Ù‚)
        const moderatorMessages = allMessages.filter(msg => msg && msg[2] && moderators.some(mod => mod.toLowerCase() === msg[2].toLowerCase()) && msg[0]);
        const timestamps = {}; const counts = {};
        moderatorMessages.forEach(msg => { const user = msg[2]; if (!msg[0]) return; try { const time = new Date(msg[0]); if (isNaN(time.getTime())) return; const officialModName = moderators.find(mod => mod.toLowerCase() === user.toLowerCase()) || user; counts[officialModName] = (counts[officialModName] || 0) + 1; if (!timestamps[officialModName]) timestamps[officialModName] = []; timestamps[officialModName].push(time); } catch (e) { console.error("Error processing mod date:", msg[0], e); } });

        if (moderators.length === 0) {
             modTableBody.innerHTML = '<tr><td colspan="7">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†.</td></tr>';
             return;
        }

        let modRowsHtml = '';
        moderators.forEach(modName => {
            const modCount = counts[modName] || 0; const modTimes = timestamps[modName] || []; let firstTimeStr = "--:--"; let lastTimeStr = "--:--"; let statusStr = "â“ Ù„Ù… ÙŠØ¸Ù‡Ø±"; let totalSec = 0; let lastMessageDateStr = ""; let isModActiveOrRecent = false;
            if (modTimes.length > 0) { modTimes.sort((a, b) => a - b); totalSec = calcEffectiveDuration(modTimes); firstTimeStr = modTimes[0].toLocaleTimeString('en-US'); const lastTimeObj = modTimes[modTimes.length - 1]; lastTimeStr = lastTimeObj.toLocaleTimeString('en-US'); lastMessageDateStr = lastTimeObj.toISOString().slice(0, 10); const now = new Date(); const sinceLastMs = now - lastTimeObj; const sinceLastTotalSeconds = Math.floor(sinceLastMs / 1000); const sinceMinutes = Math.floor(sinceLastTotalSeconds / 60); const sinceSeconds = sinceLastTotalSeconds % 60; if (sinceMinutes < 2) { statusStr = "ğŸŸ¢ Ù…ØªÙˆØ§Ø¬Ø¯ Ø§Ù„Ø¢Ù†"; isModActiveOrRecent = true; } else if (sinceMinutes < 5) { statusStr = "ğŸŸ¡ ØªÙˆØ§Ø¬Ø¯ Ù…Ù†Ø° Ù‚Ù„ÙŠÙ„"; isModActiveOrRecent = true; } else { statusStr = `ğŸ”´ ØºÙŠØ± Ù…ØªÙˆØ§Ø¬Ø¯ (${sinceMinutes} Ø¯Ù‚ÙŠÙ‚Ø© ${sinceSeconds} Ø«Ø§Ù†ÙŠØ©)`; isModActiveOrRecent = false; } } else { isModActiveOrRecent = false; }
            const durMinutes = Math.floor(totalSec / 60); const durSeconds = Math.floor(totalSec % 60);

            let cellContent = ""; let canEdit = false;
            if (isModActiveOrRecent || statusStr.startsWith('ğŸ”´')) { cellContent = lastMessageDateStr || "N/A"; canEdit = false; } else { cellContent = manualModDates[modName] || "Ù„Ø§ ÙŠÙˆØ¬Ø¯"; canEdit = true; }

            modRowsHtml += `
              <tr data-modname="${modName}">
                <td><a href="#" onclick="openUserMessages('${modName.replace(/'/g, "\\'")}', true)">${modName}</a></td>
                <td>${modCount}</td>
                <td>${durMinutes} Ø¯Ù‚ÙŠÙ‚Ø© ${durSeconds} Ø«Ø§Ù†ÙŠØ©</td>
                <td>${firstTimeStr}</td>
                <td>${lastTimeStr}</td>
                <td>${statusStr}</td>
                <td class="manual-date-cell ${canEdit ? '' : 'not-editable'}">
                  <span class="date-display">${cellContent}</span>
                  ${canEdit ? `<input type="date" class="date-input" value="${manualModDates[modName] || ''}"><button class="edit-date-btn" onclick="toggleDateEdit(this)" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®">âœï¸</button>` : ''}
                </td>
              </tr>`;
        });
        modTableBody.innerHTML = modRowsHtml;

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
        modTableBody.removeEventListener('change', handleDateInputChange); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹
        modTableBody.removeEventListener('blur', handleDateInputBlur, true);
        modTableBody.removeEventListener('keydown', handleDateInputKeydown);
        modTableBody.addEventListener('change', handleDateInputChange);
        modTableBody.addEventListener('blur', handleDateInputBlur, true);
        modTableBody.addEventListener('keydown', handleDateInputKeydown);
    }

     // --- Ø¯ÙˆØ§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠØ¯ÙˆÙŠ (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ) ---
    function toggleDateEdit(buttonElement) { /* ... Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ ... */
        const cell = buttonElement.closest('.manual-date-cell'); if (cell) { cell.classList.add('editing'); const input = cell.querySelector('.date-input'); if (input) { input.focus(); } }
    }
    function saveManualDate(inputElement) { /* ... Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ ... */
        const cell = inputElement.closest('.manual-date-cell'); if (!cell) return; const modNameToSave = cell.closest('tr')?.dataset.modname; const newDate = inputElement.value.trim(); if (!modNameToSave) return; const manualModDates = loadManualModDates(); if (newDate === "") { delete manualModDates[modNameToSave]; cell.querySelector('.date-display').textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯"; console.log(`Manual date for ${modNameToSave} cleared.`); } else { manualModDates[modNameToSave] = newDate; cell.querySelector('.date-display').textContent = newDate; console.log(`Manual date for ${modNameToSave} updated to ${newDate}`); } saveManualModDates(manualModDates); cell.classList.remove('editing');
    }
    function handleDateInputChange(event) { if (event.target.classList.contains('date-input')) { saveManualDate(event.target); } }
    function handleDateInputBlur(event) { if (event.target.classList.contains('date-input')) { const cell = event.target.closest('.manual-date-cell'); if (!cell || !event.relatedTarget || !cell.contains(event.relatedTarget)) { saveManualDate(event.target); } } }
    function handleDateInputKeydown(event) { if (event.target.classList.contains('date-input') && event.key === 'Enter') { event.preventDefault(); saveManualDate(event.target); } else if (event.target.classList.contains('date-input') && event.key === 'Escape') { const cell = event.target.closest('.manual-date-cell'); if(cell) cell.classList.remove('editing'); } }
    // -------------------------------------------------

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ù†ÙˆØ§ÙØ° (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ Ø§Ù„ØºØ§Ù„Ø¨) ---
    function increaseUsers() { visibleUserCount += 10; showAll = false; updateUserStats(); }
    function decreaseUsers() { visibleUserCount = Math.max(10, visibleUserCount - 10); showAll = false; updateUserStats(); }
    function toggleUsers() { showAll = !showAll; updateUserStats(); }

    function openUserMessages(username, fromModeratorModal = false) { /* ... Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ ... */
        openedFromModeratorModal = fromModeratorModal; closeModeratorModal(); currentUserForMessages = username; const m = document.getElementById("userMessagesModal"); if (!m) return; m.style.display = "flex"; const t = document.getElementById("userMessagesTitle"); if (t) t.textContent = `ğŸ“¨ Ø±Ø³Ø§Ø¦Ù„: ${username}`; const us = document.getElementById("userSearchText"); if (us) us.value = ""; const uf = document.getElementById("userFromTime"); if (uf) uf.value = ""; const ut = document.getElementById("userToTime"); if (ut) ut.value = ""; renderUserMessages(username); document.body.style.overflow = 'hidden';
    }
    function closeUserModal() { /* ... Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ ... */
        const modal = document.getElementById("userMessagesModal"); if (modal) { modal.style.display = "none"; currentUserForMessages = null; if (openedFromModeratorModal) { openModeratorModal(); openedFromModeratorModal = false; } else { document.body.style.overflow = 'auto'; } }
    }
    function openModeratorModal() { /* ... Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ ... */
        const modal = document.getElementById("moderatorModal"); if (modal) { modal.style.display = "flex"; renderModeratorStatus(); document.body.style.overflow = 'hidden'; }
    }
    function closeModeratorModal() { /* ... Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ ... */
         const modal = document.getElementById("moderatorModal"); if (modal) { modal.style.display = "none"; if (!document.getElementById("userMessagesModal") || document.getElementById("userMessagesModal").style.display === 'none') { document.body.style.overflow = 'auto'; } }
    }

    // --- Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (ØªØºÙŠÙŠØ± ÙƒØ¨ÙŠØ±) ---

    // ÙˆØ¸ÙŠÙØ© Ù„Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    function fetchInitialData() {
        console.log("ğŸ”„ Fetching initial data for dashboard...");
        fetch('/get_all_messages') // Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø¬Ù„
            .then(res => {
                if (!res.ok) { throw new Error(`HTTP error! status: ${res.status}`); }
                return res.json();
            })
            .then(initialMessages => {
                if (Array.isArray(initialMessages)) {
                    allMessages = initialMessages; // Ù†Ù…Ù„Ø£ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
                    console.log(`âœ… Loaded ${allMessages.length} initial messages.`);
                    updateUserStats(); // Ù†Ø¹ÙŠØ¯ Ø±Ø³Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¬Ù„ÙˆØ¨Ø©
                    // ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ« Ø£ÙŠ Ø¹Ù†Ø§ØµØ± Ø£Ø®Ø±Ù‰ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù‡Ù†Ø§
                } else {
                    console.error("âŒ Initial data received is not an array:", initialMessages);
                    allMessages = []; // Ù†Ø¨Ø¯Ø£ Ø¨Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                    updateUserStats(); // Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙØ§Ø±ØºÙ‹Ø§ Ø£Ùˆ Ø¨Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
                }
            })
            .catch(error => {
                console.error('âŒ Error fetching initial messages:', error);
                // Ø¹Ø±Ø¶ Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                const statsTableBody = document.getElementById("userStatsTableBody");
                const userCountHeader = document.getElementById("userCountHeader");
                if(statsTableBody) statsTableBody.innerHTML = '<tr><td colspan="7">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.</td></tr>';
                if(userCountHeader) userCountHeader.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„";
                allMessages = [];
            })
            .finally(() => {
                // Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠØŒ Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                console.log("ğŸš€ Starting periodic fetching for new messages...");
                setInterval(fetchNewMessages, 3500); // Ù†ÙØ³ Ø§Ù„ÙØ§ØµÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚
            });
    }

    // ÙˆØ¸ÙŠÙØ© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø· Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ
    function fetchNewMessages() {
        // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ù…Ø¹Ø±ÙØ© Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù‡Ù†Ø§ØŒ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù‡Ùˆ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø°Ù„Ùƒ
        fetch('/get_new_messages')
            .then(res => { if (!res.ok) { throw new Error(`HTTP error! status: ${res.status}`); } return res.json(); })
            .then(newMessages => {
                if (newMessages && Array.isArray(newMessages) && newMessages.length > 0) {
                    console.log(`â• Received ${newMessages.length} new messages.`);
                    // Ù†Ø¶ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                    allMessages = allMessages.concat(newMessages);
                    // *** Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ø­ÙØ¸Ù‡Ø§ ÙÙŠ localStorage ***

                    // Ù†Ø¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    updateUserStats();

                    // ØªØ­Ø¯ÙŠØ« Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
                    if (document.getElementById("moderatorModal")?.style.display === "flex") {
                        renderModeratorStatus();
                    }
                    // ØªØ­Ø¯ÙŠØ« Ù†Ø§ÙØ°Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø© ÙˆÙƒØ§Ù†Øª Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    if (currentUserForMessages && document.getElementById("userMessagesModal")?.style.display === "flex") {
                         // Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† messagesAddedØŒ ÙÙ‚Ø· Ù†Ø­Ø¯Ø« Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                         renderUserMessages(currentUserForMessages);
                    }
                } else {
                     console.log("ğŸ•’ No new messages received.");
                 }
            })
            .catch(error => {
                console.error('âŒ Error fetching new messages:', error);
                // ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø®Ø·Ø£ Ø¨Ø³ÙŠØ· Ø£Ùˆ ØªØ¬Ø§Ù‡Ù„Ù‡ Ù…Ø¤Ù‚ØªÙ‹Ø§
            });
    }

    // --- Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ---
    window.onload = function() {
        // *** Ù„Ø§ Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† localStorage ***
        // loadMessagesFromLocalStorage(); // <-- ØªÙ… Ø§Ù„Ø­Ø°Ù

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ (ÙƒÙ…Ø§ Ù‡Ùˆ)
        if (localStorage.getItem("darkMode") === "yes") {
            document.body.classList.add("dark-mode");
            const toggle = document.getElementById("darkModeToggle");
            if(toggle) toggle.textContent = "â˜€ï¸ Light Mode";
        }

        // *** Ù†Ø¨Ø¯Ø£ Ø¨Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ***
        fetchInitialData(); // <-- Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©

        // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„ØªØ±ØŒ Ù†Ø¹ÙŠØ¯ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø© Ø¹Ù„Ù‰ allMessages ÙˆÙ†Ø­Ø¯Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©)
        const userSearchInput = document.getElementById("userSearch");
        const fromTimeInput = document.getElementById("fromTime");
        const toTimeInput = document.getElementById("toTime");
        const resetBtn = document.getElementById("resetFilters");
        const handleMainFilterChange = () => {
            updateUserStats(); // Ù†Ø¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        };
        if(userSearchInput) userSearchInput.addEventListener("input", handleMainFilterChange);
        if(fromTimeInput) fromTimeInput.addEventListener("input", handleMainFilterChange);
        if(toTimeInput) toTimeInput.addEventListener("input", handleMainFilterChange);
        if(resetBtn) resetBtn.addEventListener("click", () => {
            if(userSearchInput) userSearchInput.value = "";
            if(fromTimeInput) fromTimeInput.value = "";
            if(toTimeInput) toTimeInput.value = "";
            handleMainFilterChange();
        });

        // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨ÙÙ„Ø§ØªØ± Ù†Ø§ÙØ°Ø© Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ allMessages)
        const userSearchTextInput = document.getElementById("userSearchText");
        const userFromTimeInput = document.getElementById("userFromTime");
        const userToTimeInput = document.getElementById("userToTime");
        const updateUserMessagesFilterHandler = () => {
             if (currentUserForMessages && document.getElementById("userMessagesModal")?.style.display === "flex") {
                 renderUserMessages(currentUserForMessages);
             }
        };
        if (userSearchTextInput) userSearchTextInput.addEventListener("input", updateUserMessagesFilterHandler);
        if (userFromTimeInput) userFromTimeInput.addEventListener("input", updateUserMessagesFilterHandler);
        if (userToTimeInput) userToTimeInput.addEventListener("input", updateUserMessagesFilterHandler);

        // *** ØªÙ… Ù†Ù‚Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ù„ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ ÙÙŠ fetchInitialData ***
        // console.log("ğŸš€ Starting periodic message fetching for main page...");
        // setInterval(fetchNewMessages, 3500); // <-- ØªÙ… Ø§Ù„Ù†Ù‚Ù„
    };

    // --- ÙˆØ¸ÙŠÙØ© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ (ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ) ---
    function toggleDarkMode() { /* ... Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ ... */
        document.body.classList.toggle("dark-mode"); const isDarkMode = document.body.classList.contains("dark-mode"); localStorage.setItem("darkMode", isDarkMode ? "yes" : "no"); const toggle = document.getElementById("darkModeToggle"); if(toggle) { toggle.textContent = isDarkMode ? "â˜€ï¸ Light Mode" : "ğŸŒ™ Dark Mode"; }
    }

     // --- ÙˆØ¸ÙŠÙØ© Ø²Ø± Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§) ---
     function showClearWarning() {
        // Ù„Ù… ÙŠØ¹Ø¯ Ù‡Ù†Ø§Ùƒ Ø´ÙŠØ¡ Ù„Ù€ index.html Ù„Ù…Ø³Ø­Ù‡ Ù…Ù† localStorage Ø¨Ø®ØµÙˆØµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        // ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ù† Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ø³Ø­Ù‡Ø§ Ù…Ù† Ù‡Ù†Ø§.\nØ§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† Ù„Ø§ ØªØ²Ø§Ù„ Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ ÙˆÙŠÙ…ÙƒÙ† Ù…Ø³Ø­Ù‡Ø§ Ø¨Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
        // Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø­Ù‚Ù‹Ø§ Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© Ù„Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ÙŠØ¬Ø¨ Ø¹Ù…Ù„ Ù†Ù‚Ø·Ø© Ù†Ù‡Ø§ÙŠØ© API Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ app.py
        // ÙˆØªÙƒÙˆÙ† Ù…Ø­Ù…ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§ Ù„Ø£Ù†Ù‡Ø§ Ø³ØªØ­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡.
    }

  </script>
  <!-- *** Ù†Ù‡Ø§ÙŠØ© ÙˆØ³Ù… Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„ÙˆØ§Ø­Ø¯ *** -->
</body>
</html>